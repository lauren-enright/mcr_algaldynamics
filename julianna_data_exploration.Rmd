---
title: "Pre working group data exploration: Mainly wrt coral cover"
output: html_document
date: "2024-07-02"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# clean up
rm(list=ls()) 

# load packages
require(here) # relative file paths
require(tidyverse) # data wrangling
require(vegan) # community/diversity analyses
require(lme4) # glmer()
require(emmeans) # emmeans()
require(viridis) # color palette
require(MoMAColors) # another color palette
```

# Bring in the data

These are the most recent file versions done by Lauren as of July 2, 2024

```{r}
allbenthos <- read_csv(here("data", "allbenthicdata_cleaned_colnames.csv")) 
algae <- read_csv(here("data", "algaeonly_cleaned_colnames.csv")) %>% 
  mutate(island_side = case_when(site == "lter_1" ~ "north",
                                 site == "lter_2" ~ "north",
                                 site == "lter_3" ~ "east",
                                 site == "lter_4" ~ "east",
                                 site == "lter_5" ~ "west",
                                 site == "lter_6" ~ "west",
                                 TRUE ~ "UdINGLEbUTT"))
  # going to run everything without algal turf
  # select(-algal_turf)

macroalgae <- algae %>% 
  select(-algal_turf, -crustose_corallines, -cyanophyta, -damselfish_turf, -lithophyllum_kotschyanum,
         -neogoniolithon_brassica_florida, -sporolithon_sp) # got this from the cleaning code--should Peysonellia be included?
```

# Algal alpha diversity 

Make a spp matrix to use with vegan

```{r}
# matrix of just species and their relative percent covers in the same order as the algae tibble
algae %>% 
  select(-year, -location, -site, -island_side, -habitat, -site_habitat, -transect, -quadrat) -> sppMat
```


```{r}
algae %>% 
  # grab the metadata info that is in the same order (can re-join after)
  select(year, location, site, island_side, habitat, site_habitat, transect, quadrat) %>% 
  mutate(Richness = specnumber(sppMat),
         Shannon = diversity(sppMat, "shannon"),
         Evenness = Shannon/log(Richness), # I'm pretty sure this is right but double check (Pielou's evenness)
         Richness = specnumber(sppMat)) %>% 
  # clean for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) -> algDiv
```

## Plot

Broken out by year
 
```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = habitat, y = Shannon, group = habitat)) +
  geom_boxplot() +
  facet_grid(site~year) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
```

Or without:

```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = habitat, y = Shannon, group = habitat)) +
  geom_boxplot() +
  facet_wrap(~site) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Island side:

```{r}
algDiv %>% 
  ggplot(aes(x = island_side, y = Shannon, group = island_side, fill = island_side)) +
  geom_boxplot() +
  facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```



Even simpler:

```{r}
# shannon
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = habitat, y = Shannon, group = habitat)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

# richness
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Richness, group = habitat, fill = habitat)) +
  geom_histogram() +
  theme_bw() +
  facet_wrap(~habitat) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```

Richness on top of each other

```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Richness, group = habitat, fill = habitat)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Broken up by island side

```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Richness, group = habitat, fill = habitat)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  scale_fill_viridis_d() +
  facet_wrap(~island_side)
```



# Compare algal and coral cover

```{r}
# get ranges to calculate over
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))


algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) -> algSum

algSum %>% 
  full_join(allbenthos) %>% 
  ggplot(aes(x = coral, y = AlgSum, color = year)) +
  geom_point() +
  facet_grid(site~habitat)
  
```


# Compare algal alpha diversity and coral cover

Make a joined dataframe for comparisons

```{r}
allbenthos %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, coral) %>% 
  full_join(algDiv) %>% 
  # add column for each transect ID
  rowwise() %>% 
  mutate(transect_id = paste0(site, habitat, "_", year, "_", transect)) %>% 
  # clean for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) -> coralAlgDiv  
```

## Plot Shannon

Plot Shannon diversity across sites and habitats--what's up with this structure? 

```{r}
coralAlgDiv %>% 
  ggplot(aes(x = coral, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed") # this is when two species are equally distributed (half half)--not sure why that would be
```

Try by year:

```{r}
coralAlgDiv %>% 
  filter(habitat == "backreef") %>% 
  ggplot(aes(x = coral, y = Shannon, color = as.factor(transect))) +
  geom_point() + 
  facet_grid(year~site) +
  theme_classic()
```

Or look at Shannon vs. the percent cover of algae in the plot

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  ggplot(aes(x = AlgSum, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

What about this when Richness == 2?

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  filter(Richness == 2) %>% 
  ggplot(aes(x = AlgSum, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

Could this be because the only way to get a high enough imbalance/unevenness is having a large enough algal N

What does it look like relative to turf algae?

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  filter(Richness == 2) %>% 
  ggplot(aes(x = algal_turf, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

Nic: are these lines all turf but 1 line, all turf but 2 points line, all turf but 3 points line?

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  filter(Richness == 2) %>% 
  mutate(Nonturf = AlgSum - algal_turf) %>% 
  ggplot(aes(x = AlgSum, y = Shannon, color = as.factor(Nonturf))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

^This seems to be true here. It seems like lines have to do with how much of the non-turf you have. They only do 25 points and multiply by 4 so everything is a multiple of 4. But then how can we have a 2 there??? Answer: 2020 averaging


## Plot richness

Plot richness across habitats and years

As points:


```{r}
coralAlgDiv %>% 
  ggplot(aes(x = coral, y = Richness, color = year, group = Richness)) +
  geom_jitter() + 
  facet_grid(habitat~site) +
  theme_classic()
```

```{r}
coralAlgDiv %>% 
  ggplot(aes(x = Richness, y = coral, color = year, group = Richness)) +
  geom_boxplot() + 
  facet_grid(year ~ habitat) +
  theme_classic()
```

Plot richness across sites and habitats

```{r}
coralAlgDiv %>% 
  ggplot(aes(x = Richness, y = coral, fill = habitat, group = Richness)) +
  geom_boxplot() + 
  facet_grid(island_side ~ habitat) +
  scale_fill_viridis_d() +
  theme_classic()
```


## Make a bad richness model 

Dumb model--need to think more about random effects and figure out time component, but instructive to see there may be a relationship

```{r}
m1 <- glmer(Richness ~ scale(coral) + habitat + island_side + (1|site) + (1|transect_id) + (1|year), 
            family = poisson(link = "log"), data = coralAlgDiv)
  plot(m1) # I think this looks pretty weird right?
  summary(m1)
  emmeans(m1, ~ habitat)
```

## Plot evenness

Plot evennes across habitats and years

As points:


```{r}
coralAlgDiv %>% 
  ggplot(aes(x = coral, y = Evenness, color = year, group = Evenness)) +
  geom_jitter() + 
  facet_grid(habitat~site) +
  theme_classic()
```

# Plot changes of algae, coral, etc. through time

```{r make a big joined tibble}
startMAlg <- grep("acanthophora_spicifera", colnames(macroalgae))
endMAlg <- grep("valonia_ventricosa", colnames(macroalgae))

macroalgae %>% 
  mutate(macroalgae_sum = rowSums(macroalgae[startMAlg:endMAlg])) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, macroalgae_sum) %>% 
  full_join(coralAlgDiv) %>% 
  full_join(algae) %>% 
  rowwise() %>% 
  mutate(turf_sum = sum(algal_turf, damselfish_turf),
         CCA_sum = sum(lithophyllum_kotschyanum, crustose_corallines, neogoniolithon_brassica_florida, sporolithon_sp)) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, turf_sum, CCA_sum, coral, macroalgae_sum) %>% 
  # pivot key columns longer
  pivot_longer(cols = c(turf_sum, CCA_sum, coral, macroalgae_sum),
               names_to = "substrate",
               values_to = "sum_cover") %>% 
  # summarize and group quadrats by transects
  group_by(year, site, habitat, site_habitat, transect, island_side, substrate) %>% 
  summarise(avg_cov = mean(sum_cover)) -> transect4mean
  
            

```

## Quadrat level island-habitat

```{r make a df for island side/habitat}
macroalgae %>% 
  mutate(macroalgae_sum = rowSums(macroalgae[startMAlg:endMAlg])) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, macroalgae_sum) %>% 
  full_join(coralAlgDiv) %>% 
  full_join(algae) %>% 
  rowwise() %>% 
  mutate(turf_sum = sum(algal_turf, damselfish_turf),
         CCA_sum = sum(lithophyllum_kotschyanum, crustose_corallines, neogoniolithon_brassica_florida, sporolithon_sp)) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, turf_sum, CCA_sum, coral, macroalgae_sum) %>% 
  # pivot key columns longer
  pivot_longer(cols = c(turf_sum, CCA_sum, coral, macroalgae_sum),
               names_to = "substrate",
               values_to = "sum_cover") %>% 
  # summarize and group quadrats by island/habitat
  group_by(year, habitat, island_side, substrate) %>% 
  summarise(mean_cov = mean(sum_cover),
            sd_cov = sd(sum_cover, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = factor(island_side, levels = c("north", "east", "west")),
         habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) -> quadHabIS
  
            
```

```{r plot cover through time}
quadHabIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_grid(island_side ~ habitat) +
  ylab("Mean cover (%)") +
  xlab("Year")
```

## Transect-level island/habitat

```{r make a df for island side/habitat}
transect4mean %>% 
  group_by(year, habitat, island_side, substrate) %>% 
  summarise(mean_cov = mean(avg_cov),
            sd_cov = sd(avg_cov, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = factor(island_side, levels = c("north", "east", "west")),
         habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) -> transectHabIS
  
            
```

```{r plot cover through time}
# this color palette:
#moma.colors("Abbott", type = "discrete")

transectHabIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_grid(island_side ~ habitat) +
  ylab("Mean cover (%)") +
  xlab("Year")
```


## Transect-level habitat

```{r make a df for island side/habitat}
transect4mean %>% 
  group_by(year, habitat, substrate) %>% 
  summarise(mean_cov = mean(avg_cov),
            sd_cov = sd(avg_cov, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) -> transectHab
  
            
```

```{r plot cover through time}
# this color palette:
#moma.colors("Abbott", type = "discrete")

transectHab %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_wrap(~habitat) +
  ylab("Mean cover (%)") +
  xlab("Year")
```

## Transect level island side

```{r make a df for island side}
transect4mean %>% 
  group_by(year, island_side, substrate) %>% 
  summarise(mean_cov = mean(avg_cov),
            sd_cov = sd(avg_cov, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = factor(island_side, levels = c("north", "east", "west"))) -> transectIS
  
            
```

```{r plot cover through time}

transectIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_grid(~island_side) +
  ylab("Mean cover (%)") +
  xlab("Year")
```


# Examine most abundant algae

Reformat so that the data are easier to summarize: 

```{r}
# get ranges to calculate over
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))


algae %>% 
  pivot_longer(cols = colnames(algae)[startAlg:endAlg],
               names_to = "taxa",
               values_to = "percent") -> algaeLong
```

Get some summary statistics

## Across all time, by habitat:

```{r}
algaeLong %>% 
  group_by(site, habitat, year, transect, island_side, taxa) %>% # get transect summaries
  summarize(Mean_cov = mean(percent), 
            Num_occur = n(), 
            sd_cov = sd(percent)) -> algTaxTrans
  
```

Plot

```{r}
algTaxTrans %>% 
  ggplot(aes(x = reorder(taxa, -Mean_cov), y = Mean_cov, fill = habitat)) +
  geom_boxplot() + 
  scale_fill_viridis_d() +
  facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

With just macroalgae:

```{r}
algTaxTrans %>% 
  filter(! taxa %in% c("algal_turf", "crustose_corallines", "cyanophyta", "damselfish_turf", "lithophyllum_kotschyanum", "neogoniolithon_brassica_florida", "sporolithon_sp" )) %>% # this list taken from the cleaning code
  ggplot(aes(x = reorder(taxa, -Mean_cov), y = Mean_cov, fill = habitat)) +
  geom_boxplot() + 
  scale_fill_viridis_d() +
  facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Not by habitat

```{r}
algTaxTrans %>% 
  filter(! taxa %in% c("algal_turf", "crustose_corallines", "cyanophyta", "damselfish_turf", "lithophyllum_kotschyanum", "neogoniolithon_brassica_florida", "sporolithon_sp" )) %>% # this list taken from the cleaning code
  ggplot(aes(x = reorder(taxa, -Mean_cov), y = Mean_cov)) +
  geom_boxplot() + 
  scale_fill_viridis_d() +
  #facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Beta diversity

## Distance matrix

We get an error message if we run vegdist right away saying that we have empty rows and that their dissimilarities may be meaningless. Let's look to see if any rows have no algae at all:

```{r}
sppMat %>% 
  mutate(AlgSum = rowSums(across(where(is.numeric)))) %>% 
  filter(AlgSum == 0) %>% dim() # 672 with no algae at all
```

Need to run this without zero observations, so we'll exclude quadrats with no algae and make a species matrix

```{r}
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# spp matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>% 
  select(-year, -location, -island_side, -site, -habitat, -site_habitat, -transect, -quadrat, -AlgSum) -> sppMat0

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>%
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year)) -> sppMeta0

```

Calculate Bray Curtis distances

```{r}
brayMat <- vegdist(sppMat0, "bray") # 1 is maximum dissimilarity
```

Calculate dispersion (this is using Noam's code)

- Talking with Lauren, decided want to be smart about which groupings we do for `betadisper()`. Priorities are:
  1. Year-habitat as the group: include turf/cyano/everything
  2. Island side - year - habitat

```{r}
habBetaDisper <- vegan::betadisper(brayMat, sppMeta0$hab_year)

# plot of dispersion test
plot(habBetaDisper, sub = "") # lol
boxplot(habBetaDisper, main = "Habitat", xlab = "") 
```



