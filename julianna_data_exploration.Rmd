---
title: "Pre working group data exploration: Mainly wrt coral cover"
output: html_document
date: "2024-07-02"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# clean up
rm(list=ls()) 

# load packages
require(here) # relative file paths
require(tidyverse) # data wrangling
require(vegan) # community/diversity analyses
require(lme4) # glmer()
require(emmeans) # emmeans()
require(viridis) # color palette
require(MoMAColors) # another color palette
require(patchwork) # putting figures together
require(BiodiversityR)
require(ggsci) # scientific jounral and sci-fi themed color palette
```

# Bring in the data

These are the most recent file versions done by Lauren as of July 2, 2024

```{r}
allbenthos <- read_csv(here("data", "allbenthicdata_cleaned_colnames.csv")) 
algae <- read_csv(here("data", "algaeonly_cleaned_colnames.csv")) %>% 
  mutate(island_side = case_when(site == "lter_1" ~ "north",
                                 site == "lter_2" ~ "north",
                                 site == "lter_3" ~ "east",
                                 site == "lter_4" ~ "east",
                                 site == "lter_5" ~ "west",
                                 site == "lter_6" ~ "west",
                                 TRUE ~ "UdINGLEbUTT"))
  # going to run everything without algal turf
  # select(-algal_turf)

macroalgae <- algae %>% 
  select(-algal_turf, -crustose_corallines, -cyanophyta, -damselfish_turf, -lithophyllum_kotschyanum,
         -neogoniolithon_brassica_florida, -sporolithon_sp) # got this from the cleaning code--should Peysonellia be included?
```

# Algal alpha diversity 

Make a spp matrix to use with vegan

```{r}
# matrix of just species and their relative percent covers in the same order as the algae tibble
algae %>% 
  select(-year, -location, -site, -island_side, -habitat, -site_habitat, -transect, -quadrat) -> sppMat

# get ranges to calculate over
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year),
         island_side_hab_year = paste0(island_side, "_", hab_year)) -> sppMeta
```


```{r}
algae %>% 
  # grab the metadata info that is in the same order (can re-join after)
  select(year, location, site, island_side, habitat, site_habitat, transect, quadrat) %>% 
  mutate(Richness = specnumber(sppMat),
         Shannon = diversity(sppMat, "shannon"),
         Evenness = Shannon/log(Richness), # I'm pretty sure this is right but double check (Pielou's evenness)
         Richness = specnumber(sppMat)) %>% 
  # clean for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) -> algDiv
```

## Plot

Broken out by year
 
```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = habitat, y = Shannon, group = habitat)) +
  geom_boxplot() +
  facet_grid(site~year) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
```

Or without:

```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = habitat, y = Shannon, group = habitat)) +
  geom_boxplot() +
  facet_wrap(~site) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Island side:

```{r}
algDiv %>% 
  ggplot(aes(x = island_side, y = Shannon, group = island_side, fill = island_side)) +
  geom_boxplot() +
  facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```



Even simpler:

```{r}
# shannon
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = habitat, y = Shannon, group = habitat)) +
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

# richness
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Richness, group = habitat, fill = habitat)) +
  geom_histogram() +
  theme_bw() +
  facet_wrap(~habitat) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

```

Richness on top of each other

```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Richness, group = habitat, fill = habitat)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1))
```

Broken up by island side

```{r}
algDiv %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Richness, group = habitat, fill = habitat)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  scale_fill_viridis_d() +
  facet_wrap(~island_side)
```



# Compare algal and coral cover

```{r}
# get ranges to calculate over
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))


algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) -> algSum

algSum %>% 
  full_join(allbenthos) %>% 
  ggplot(aes(x = coral, y = AlgSum, color = year)) +
  geom_point() +
  facet_grid(site~habitat) +
  ylab("Algal cover (%)") +
  xlab("Coral cover (%)")
  
```


# Compare algal alpha diversity and coral cover

Make a joined dataframe for comparisons

```{r}
allbenthos %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, coral) %>% 
  full_join(algDiv) %>% 
  # add column for each transect ID
  rowwise() %>% 
  mutate(transect_id = paste0(site, habitat, "_", year, "_", transect)) %>% 
  # clean for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) -> coralAlgDiv  
```

## Plot Shannon

Plot Shannon diversity across sites and habitats--what's up with this structure? 

```{r}
coralAlgDiv %>% 
  ggplot(aes(x = coral, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed") # this is when two species are equally distributed (half half)--not sure why that would be
```

Try by year:

```{r}
coralAlgDiv %>% 
  filter(habitat == "backreef") %>% 
  ggplot(aes(x = coral, y = Shannon, color = as.factor(transect))) +
  geom_point() + 
  facet_grid(year~site) +
  theme_classic()
```

Or look at Shannon vs. the percent cover of algae in the plot

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  ggplot(aes(x = AlgSum, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

What about this when Richness == 2?

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  filter(Richness == 2) %>% 
  ggplot(aes(x = AlgSum, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

Could this be because the only way to get a high enough imbalance/unevenness is having a large enough algal N

What does it look like relative to turf algae?

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  filter(Richness == 2) %>% 
  ggplot(aes(x = algal_turf, y = Shannon, color = as.factor(Richness))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

Nic: are these lines all turf but 1 line, all turf but 2 points line, all turf but 3 points line?

```{r}
coralAlgDiv %>% 
  full_join(algSum) %>% 
  filter(Richness == 2) %>% 
  mutate(Nonturf = AlgSum - algal_turf) %>% 
  ggplot(aes(x = AlgSum, y = Shannon, color = as.factor(Nonturf))) +
  geom_point(alpha = 0.5) + 
  facet_grid(habitat~site) +
  theme_classic() + 
  geom_hline(yintercept = 0.693, color = "red", linetype = "dashed")
```

^This seems to be true here. It seems like lines have to do with how much of the non-turf you have. They only do 25 points and multiply by 4 so everything is a multiple of 4. But then how can we have a 2 there??? Answer: 2020 averaging


## Plot richness

Plot richness across habitats and years

As points:


```{r}
coralAlgDiv %>% 
  ggplot(aes(x = coral, y = Richness, color = year, group = Richness)) +
  geom_jitter() + 
  facet_grid(habitat~island_side) +
  theme_classic()
```

As boxplots

```{r}
coralAlgDiv %>% 
  ggplot(aes(x = Richness, y = coral, color = island_side, group = Richness)) +
  geom_boxplot() + 
  facet_grid(habitat~island_side) +
  scale_color_manual(values = c("darkblue", "darkred", "darkgreen")) +
  theme_classic()

```


```{r}
coralAlgDiv %>% 
  ggplot(aes(x = Richness, y = coral, color = year, group = Richness)) +
  geom_boxplot() + 
  facet_grid(year ~ habitat) +
  theme_classic()
```

Plot richness across sites and habitats

```{r}
coralAlgDiv %>% 
  ggplot(aes(x = Richness, y = coral, fill = habitat, group = Richness)) +
  geom_boxplot() + 
  facet_grid(island_side ~ habitat) +
  scale_fill_viridis_d() +
  theme_classic()
```


## Make a bad richness model 

Dumb model--need to think more about random effects and figure out time component, but instructive to see there may be a relationship

```{r}
m1 <- glmer(Richness ~ scale(coral) + habitat + island_side + (1|site) + (1|transect_id) + (1|year), 
            family = poisson(link = "log"), data = coralAlgDiv)
  plot(m1) # I think this looks pretty weird right?
  summary(m1)
  emmeans(m1, ~ habitat)
```

## Plot evenness

Plot evennes across habitats and years

As points:


```{r}
coralAlgDiv %>% 
  ggplot(aes(x = coral, y = Evenness, color = year, group = Evenness)) +
  geom_jitter() + 
  facet_grid(habitat~site) +
  theme_classic()
```

# Species accummulation curves

## Set special theme

From https://rpubs.com/Roeland-KINDT/694021 

```{r}
BioR.theme <- theme(
        panel.background = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line("gray25"),
        text = element_text(size = 12),
        axis.text = element_text(size = 10, colour = "gray25"),
        axis.title = element_text(size = 14, colour = "gray25"),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 14),
        legend.key = element_blank())
```


## By habitat (all time)

Noam suggested doing this on July 10, 2024 in response to the richness plots. To learn how to do this, I used this tutorial: https://rpubs.com/Roeland-KINDT/694021 

```{r accumpcomp}
# use accumcomp() to calculate accumulated species richness
# conditioned = FALSE switches estimation of standard deviation to a formula based on the estimation of extrapolated species richness
# returns data on species accumulations separately for each different level of a factor
accum.Hab <- accumcomp(sppMat, # spp matrix
                     y = sppMeta, # metadata df (same length)
                     factor = 'habitat', # factor to group by in the metadata file
    method='exact', conditioned = FALSE, plotit = FALSE)
```

To plot, use accumcomp.long() to get it into long/ggplot format

```{r make long}
accum.Hablong <- accumcomp.long(accum.Hab, ci=NA, 
                              label.freq=2000) # lebel.freq adjusts the labelit variabel to show how often a symbol will be plotted on the SAC
```

Plot

```{r plot}
accum.Hablong %>% 
  mutate(Grouping = factor(Grouping, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = Sites, y = Richness, ymax = UPR, ymin = LWR)) +
  scale_x_continuous(expand=c(0, 1), sec.axis = dup_axis(labels=NULL, name=NULL)) + # this moves it so zero is right at the origin
  scale_y_continuous(sec.axis = dup_axis(labels=NULL, name=NULL)) + # this makes it more like a box
  geom_line(aes(colour=Grouping), linewidth=2) + # adds line
  #geom_point(data=subset(accum.Hablong, labelit==TRUE), 
  #             aes(colour=Grouping, shape=Grouping), size=.5) +
  geom_ribbon(aes(colour=Grouping), alpha=0.2, show.legend=FALSE) + 
  BioR.theme +
  scale_colour_viridis_d(direction = -1) +
  labs(x = "Quadrats", y = "Richness", colour = "Haitat", shape = "Haitat")
```


## By island side (all time)

```{r accumpcomp}
# use accumcomp() to calculate accumulated species richness
# conditioned = FALSE switches estimation of standard deviation to a formula based on the estimation of extrapolated species richness
# returns data on species accumulations separately for each different level of a factor
accum.IS <- accumcomp(sppMat, # spp matrix
                     y = sppMeta, # metadata df (same length)
                     factor = 'island_side', # factor to group by in the metadata file
    method='exact', conditioned = FALSE, plotit = FALSE)
```

To plot, use accumcomp.long() to get it into long/ggplot format

```{r make long}
accum.ISlong <- accumcomp.long(accum.IS, ci=NA, 
                              label.freq=2000) # lebel.freq adjusts the labelit variabel to show how often a symbol will be plotted on the SAC
```

Plot

```{r plot}
accum.ISlong %>% 
  mutate(Grouping = factor(Grouping, levels = c("north", "east", "west"))) %>% 
  ggplot(aes(x = Sites, y = Richness, ymax = UPR, ymin = LWR)) +
  scale_x_continuous(expand=c(0, 1), sec.axis = dup_axis(labels=NULL, name=NULL)) + # this moves it so zero is right at the origin
  scale_y_continuous(sec.axis = dup_axis(labels=NULL, name=NULL)) + # this makes it more like a box
  geom_line(aes(colour=Grouping), linewidth=2) + # adds line
  #geom_point(data=subset(accum.Hablong, labelit==TRUE), 
  #             aes(colour=Grouping, shape=Grouping), size=.5) +
  geom_ribbon(aes(colour=Grouping), alpha=0.2, show.legend=FALSE) + 
  BioR.theme +
  scale_color_manual(values = c("darkblue", "darkred", "darkgreen")) +
  labs(x = "Quadrats", y = "Richness", colour = "Haitat", shape = "Haitat")
```

## By habitat-time

Noam suggested doing this on July 10, 2024 in response to the richness plots. To learn how to do this, I used this tutorial: https://rpubs.com/Roeland-KINDT/694021 

```{r accumpcomp}
# use accumcomp() to calculate accumulated species richness
# conditioned = FALSE switches estimation of standard deviation to a formula based on the estimation of extrapolated species richness
# returns data on species accumulations separately for each different level of a factor
accum.HabYr <- accumcomp(sppMat, # spp matrix
                     y = sppMeta, # metadata df (same length)
                     factor = 'hab_year', # factor to group by in the metadata file
    method='exact', conditioned = FALSE, plotit = FALSE)
```

To plot, use accumcomp.long() to get it into long/ggplot format

```{r make long}
accum.HabYrlong <- accumcomp.long(accum.HabYr, ci=NA, 
                              label.freq=2000) %>% # lebel.freq adjusts the labelit variabel to show how often a symbol will be plotted on the SAC
  # get metadata back
  rowwise() %>% 
  mutate(Year = (str_split(Grouping, pattern = "_")[[1]])[length(str_split(Grouping, pattern = "_")[[1]])]) %>% 
  mutate(Habitat = case_when(
    str_split(Grouping, pattern = "_")[[1]][[2]] == "17" ~ "outer_17",
    str_split(Grouping, pattern = "_")[[1]][[2]] == "10" ~ "outer_10",
    str_split(Grouping, pattern = "_")[[1]][[1]] == "fringing" ~ "fringing",
    str_split(Grouping, pattern = "_")[[1]][[1]] == "backreef" ~ "backreef",
    TRUE ~ "Error"
    )) %>% 
  mutate(Habitat = factor(Habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) 
```

Plot

```{r plot}
accum.HabYrlong %>% 
  ggplot(aes(x = Sites, y = Richness, ymax = UPR, ymin = LWR)) +
  scale_x_continuous(expand=c(0, 1), sec.axis = dup_axis(labels=NULL, name=NULL)) + # this moves it so zero is right at the origin
  scale_y_continuous(sec.axis = dup_axis(labels=NULL, name=NULL)) + # this makes it more like a box
  geom_line(aes(colour=Year), linewidth=2) + # adds line
  #geom_point(data=subset(accum.Hablong, labelit==TRUE), 
  #             aes(colour=Grouping, shape=Grouping), size=.5) +
  #geom_ribbon(aes(colour=Year), alpha=0.2, show.legend=FALSE) + 
  BioR.theme +
  scale_colour_viridis_d(direction = -1) +
  facet_wrap(~Habitat) +
  labs(x = "Quadrats", y = "Richness", colour = "Haitat", shape = "Haitat")
```


## By habitat-time-island side

```{r accumpcomp}
# use accumcomp() to calculate accumulated species richness
# conditioned = FALSE switches estimation of standard deviation to a formula based on the estimation of extrapolated species richness
# returns data on species accumulations separately for each different level of a factor
accum.HabISYr <- accumcomp(sppMat, # spp matrix
                     y = sppMeta, # metadata df (same length)
                     factor = 'island_side_hab_year', # factor to group by in the metadata file
    method='exact', conditioned = FALSE, plotit = FALSE)
```

To plot, use accumcomp.long() to get it into long/ggplot format

```{r make long}
accum.HabISYrlong <- accumcomp.long(accum.HabISYr, ci=NA, 
                              label.freq=2000) %>% # lebel.freq adjusts the labelit variabel to show how often a symbol will be plotted on the SAC
  # get metadata back
  rowwise() %>% 
  mutate(Year = (str_split(Grouping, pattern = "_")[[1]])[length(str_split(Grouping, pattern = "_")[[1]])]) %>% 
  mutate(Habitat = case_when(
    str_split(Grouping, pattern = "_")[[1]][[3]] == "17" ~ "outer_17",
    str_split(Grouping, pattern = "_")[[1]][[3]] == "10" ~ "outer_10",
    str_split(Grouping, pattern = "_")[[1]][[2]] == "fringing" ~ "fringing",
    str_split(Grouping, pattern = "_")[[1]][[2]] == "backreef" ~ "backreef",
    TRUE ~ "Error"
    )) %>% 
  mutate(island_side = str_split(Grouping, pattern = "_")[[1]][[1]]) %>% 
  mutate(Habitat = factor(Habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) 
```

Plot

```{r plot}
accum.HabISYrlong %>% 
  ggplot(aes(x = Sites, y = Richness, ymax = UPR, ymin = LWR)) +
  scale_x_continuous(expand=c(0, 1), sec.axis = dup_axis(labels=NULL, name=NULL)) + # this moves it so zero is right at the origin
  scale_y_continuous(sec.axis = dup_axis(labels=NULL, name=NULL)) + # this makes it more like a box
  geom_line(aes(colour=Year), linewidth=1) + # adds line
  #geom_point(data=subset(accum.Hablong, labelit==TRUE), 
  #             aes(colour=Grouping, shape=Grouping), size=.5) +
  #geom_ribbon(aes(colour=Year), alpha=0.2, show.legend=FALSE) + 
  BioR.theme +
  scale_colour_viridis_d(direction = -1) +
  facet_grid(island_side ~ Habitat) +
  labs(x = "Quadrats", y = "Richness")
```

# Plot changes of algae, coral, etc. through time


```{r make a big joined tibble}
startMAlg <- grep("acanthophora_spicifera", colnames(macroalgae))
endMAlg <- grep("valonia_ventricosa", colnames(macroalgae))

macroalgae %>% 
  mutate(macroalgae_sum = rowSums(macroalgae[startMAlg:endMAlg])) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, macroalgae_sum) %>% 
  full_join(coralAlgDiv) %>% 
  full_join(algae) %>% 
  rowwise() %>% 
  mutate(turf_sum = sum(algal_turf, damselfish_turf),
         CCA_sum = sum(lithophyllum_kotschyanum, crustose_corallines, neogoniolithon_brassica_florida, sporolithon_sp)) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, turf_sum, CCA_sum, coral, macroalgae_sum) %>% 
  # pivot key columns longer
  pivot_longer(cols = c(turf_sum, CCA_sum, coral, macroalgae_sum),
               names_to = "substrate",
               values_to = "sum_cover") %>% 
  # summarize and group quadrats by transects
  group_by(year, site, habitat, site_habitat, transect, island_side, substrate) %>% 
  summarise(avg_cov = mean(sum_cover)) -> transect4mean
  
            

```

## Quadrat level island-habitat

```{r make a df for island side/habitat}
macroalgae %>% 
  mutate(macroalgae_sum = rowSums(macroalgae[startMAlg:endMAlg])) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, macroalgae_sum) %>% 
  full_join(coralAlgDiv) %>% 
  full_join(algae) %>% 
  rowwise() %>% 
  mutate(turf_sum = sum(algal_turf, damselfish_turf),
         CCA_sum = sum(lithophyllum_kotschyanum, crustose_corallines, neogoniolithon_brassica_florida, sporolithon_sp)) %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side, turf_sum, CCA_sum, coral, macroalgae_sum) %>% 
  # pivot key columns longer
  pivot_longer(cols = c(turf_sum, CCA_sum, coral, macroalgae_sum),
               names_to = "substrate",
               values_to = "sum_cover") -> quad4sum

quad4sum %>% 
  # summarize and group quadrats by island/habitat
  group_by(year, habitat, island_side, substrate) %>% 
  summarise(mean_cov = mean(sum_cover),
            sd_cov = sd(sum_cover, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = str_to_sentence(island_side),
         island_side = factor(island_side, levels = c("North", "East", "West")),
         habitat = case_when(
           str_detect(habitat, pattern = "_") ~ str_to_sentence(paste0(str_split(habitat, "_")[[1]][1], " ", str_split(habitat, "_")[[1]][2])),
           TRUE ~ str_to_sentence(habitat)),
         habitat = factor(habitat, levels = c("Fringing", "Backreef", "Outer 10", "Outer 17"))) -> quadHabIS
  
            
```

```{r plot cover through time}
quadHabIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  ),
  labels = c("CCA", "Coral", "Macroalgae", "Turf algae")) +
  facet_grid(island_side ~ habitat) +
  ylab("Mean cover (%)") +
  xlab("Year")
```

## Quarat-level habitat-site

```{r get summary}

quad4sum %>% 
  # summarize and group quadrats by island/habitat
  group_by(year, habitat, site, island_side, substrate) %>% 
  summarise(mean_cov = mean(sum_cover),
            sd_cov = sd(sum_cover, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = str_to_sentence(island_side),
         island_side = factor(island_side, levels = c("North", "East", "West")),
         habitat = case_when(
           str_detect(habitat, pattern = "_") ~ str_to_sentence(paste0(str_split(habitat, "_")[[1]][1], " ", str_split(habitat, "_")[[1]][2])),
           TRUE ~ str_to_sentence(habitat)),
         habitat = factor(habitat, levels = c("Fringing", "Backreef", "Outer 10", "Outer 17"))) %>% 
  mutate(site = case_when(
    site == "lter_1" ~ "LTER 1 (N)",
    site == "lter_2" ~ "LTER 2 (N)",
    site == "lter_3" ~ "LTER 3 (E)",
    site == "lter_4" ~ "LTER 4 (E)",
    site == "lter_5" ~ "LTER 5 (W)",
    site == "lter_6" ~ "LTER 6 (W)"
  )) -> quadHabSite
  
            
```

```{r plot cover through time}
# pdf("Fig1_quadHabSiteNo20.pdf", height = 6.5, width = 12)

quadHabSite %>% 
  filter(year != 2020) %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  ),
  labels = c("CCA", "Coral", "Macroalgae", "Turf algae")) +
  facet_grid(habitat ~ site) + # not sure which direction is best here
  ylab("Mean cover (%)") +
  xlab("Year") +
  # add lines for disturbances
  geom_vline(xintercept = 2006, linetype = "dotdash") + # start of COTS
  geom_vline(xintercept = 2010,  color = "darkgray") + # cyclone Oli
  geom_vline(xintercept = 2019, linetype = "dashed", color = "red")  # bleaching

# dev.off()
```


## Quadrat-level habitat

```{r make a df for island side/habitat}
quad4sum %>% 
  # summarize and group quadrats by island/habitat
  group_by(year, habitat, substrate) %>% 
  summarise(mean_cov = mean(sum_cover),
            sd_cov = sd(sum_cover, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_wrap(~habitat, nrow = 1) +
  ylab("Mean cover (%)") +
  xlab("Year")
            
```


## Transect-level island/habitat

```{r make a df for island side/habitat}
transect4mean %>% 
  group_by(year, habitat, island_side, substrate) %>% 
  summarise(mean_cov = mean(avg_cov),
            sd_cov = sd(avg_cov, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = factor(island_side, levels = c("north", "east", "west")),
         habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) -> transectHabIS
  
            
```

```{r plot cover through time}
# this color palette:
#moma.colors("Abbott", type = "discrete")

transectHabIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_grid(island_side ~ habitat) +
  ylab("Mean cover (%)") +
  xlab("Year")
```


## Transect-level habitat

```{r make a df for island side/habitat}
transect4mean %>% 
  group_by(year, habitat, substrate) %>% 
  summarise(mean_cov = mean(avg_cov),
            sd_cov = sd(avg_cov, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) -> transectHab
  
            
```

```{r plot cover through time}
# this color palette:
#moma.colors("Abbott", type = "discrete")

transectHab %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_wrap(~habitat, nrow = 1) +
  ylab("Mean cover (%)") +
  xlab("Year")
```

## Transect level island side

```{r make a df for island side}
transect4mean %>% 
  group_by(year, island_side, substrate) %>% 
  summarise(mean_cov = mean(avg_cov),
            sd_cov = sd(avg_cov, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = factor(island_side, levels = c("north", "east", "west"))) -> transectIS
  
            
```

```{r plot cover through time}

transectIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_grid(~island_side) +
  ylab("Mean cover (%)") +
  xlab("Year")
```

## Quadrat-level island side

```{r}
quad4sum %>% 
  # summarize and group quadrats by island/habitat
  group_by(year, island_side, substrate) %>% 
  summarise(mean_cov = mean(sum_cover),
            sd_cov = sd(sum_cover, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(island_side = factor(island_side, levels = c("north", "east", "west"))) %>% 
  ggplot(aes(x = year, y = mean_cov, group = substrate, fill = substrate)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_manual(values = c(
    moma.colors("Klein", type = "discrete")[2], # CCA
    moma.colors("Klein", type = "discrete")[1], # coral
    moma.colors("Klein", type = "discrete")[5], # macro
    moma.colors("Klein", type = "discrete")[4] # turf
  )) +
  facet_wrap(~island_side, nrow = 1) +
  ylab("Mean cover (%)") +
  xlab("Year")
```


## Plot by substrate with habitat as the facet

By transect

```{r plot}
transectHabIS %>% 
  ggplot(aes(x = year, y = mean_cov, group = habitat, fill = habitat)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_viridis_d(direction = -1) +
  facet_grid(substrate ~ island_side) +
  ylab("Mean cover (%)") +
  xlab("Year")
```

By quadrat

```{r}
quad4sum %>% 
  # summarize and group quadrats by island/habitat
  group_by(year, habitat, island_side, substrate) %>% 
  summarise(mean_cov = mean(sum_cover),
            sd_cov = sd(sum_cover, na.rm = TRUE),
            n = n(),
            CI95 = 1.96*(sd_cov)/sqrt(n)) %>% 
  # relevel for graphing
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) %>% 
  ggplot(aes(x = year, y = mean_cov, group = habitat, fill = habitat)) +
  geom_ribbon(aes(ymin = mean_cov -CI95, 
                    ymax = mean_cov + CI95),
              alpha  = 0.7) +
  geom_line() +
  theme_bw() +
  scale_fill_viridis_d(direction = -1) +
  facet_grid(substrate ~ island_side) +
  ylab("Mean cover (%)") +
  xlab("Year")
```



# Examine most abundant algae

Reformat so that the data are easier to summarize: 

```{r}
# get ranges to calculate over
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))


algae %>% 
  pivot_longer(cols = colnames(algae)[startAlg:endAlg],
               names_to = "taxa",
               values_to = "percent") -> algaeLong
```

Get some summary statistics

## Across all time, by habitat:

```{r}
algaeLong %>% 
  group_by(site, habitat, year, transect, island_side, taxa) %>% # get transect summaries
  summarize(Mean_cov = mean(percent), 
            Num_occur = n(), 
            sd_cov = sd(percent)) -> algTaxTrans
  
```

Plot

```{r}
algTaxTrans %>% 
  ggplot(aes(x = reorder(taxa, -Mean_cov), y = Mean_cov, fill = habitat)) +
  geom_boxplot() + 
  scale_fill_viridis_d() +
  facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

With just macroalgae:

```{r}
algTaxTrans %>% 
  filter(! taxa %in% c("algal_turf", "crustose_corallines", "cyanophyta", "damselfish_turf", "lithophyllum_kotschyanum", "neogoniolithon_brassica_florida", "sporolithon_sp" )) %>% # this list taken from the cleaning code
  ggplot(aes(x = reorder(taxa, -Mean_cov), y = Mean_cov, fill = habitat)) +
  geom_boxplot() + 
  scale_fill_viridis_d() +
  facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Not by habitat

```{r}
algTaxTrans %>% 
  filter(! taxa %in% c("algal_turf", "crustose_corallines", "cyanophyta", "damselfish_turf", "lithophyllum_kotschyanum", "neogoniolithon_brassica_florida", "sporolithon_sp" )) %>% # this list taken from the cleaning code
  ggplot(aes(x = reorder(taxa, -Mean_cov), y = Mean_cov)) +
  geom_boxplot() + 
  scale_fill_viridis_d() +
  #facet_wrap(~habitat) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Beta diversity

## Distance matrix: habitat-year

We get an error message if we run vegdist right away saying that we have empty rows and that their dissimilarities may be meaningless. Let's look to see if any rows have no algae at all:

```{r look for zeros}
sppMat %>% 
  mutate(AlgSum = rowSums(across(where(is.numeric)))) %>% 
  filter(AlgSum == 0) %>% dim() # 672 with no algae at all
```

Need to run this without zero observations, so we'll exclude quadrats with no algae and make a species matrix

```{r get spp mat df}
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# spp matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>% 
  select(-year, -location, -island_side, -site, -habitat, -site_habitat, -transect, -quadrat, -AlgSum) -> sppMat0

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>%
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year),
         island_side_hab_year = paste0(island_side, hab_year)) -> sppMeta0

```

Start with just one habitat at a time

### Fringing

```{r get fringe mat}
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# spp matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>% 
  filter(habitat == "fringing") %>% 
  select(-year, -location, -island_side, -site, -habitat, -site_habitat, -transect, -quadrat, -AlgSum) -> sppMat0fring

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>%
   filter(habitat == "fringing") %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year),
         island_side_hab_year = paste0(island_side, hab_year),
         island_side_year = paste0(island_side, year)) -> sppMeta0fring
```


Calculate Bray Curtis distances

```{r calculate distances}
brayMatFring <- vegdist(sppMat0fring, "bray") # 1 is maximum dissimilarity
```

Calculate dispersion (this is using Noam's code)

- Talking with Lauren, decided want to be smart about which groupings we do for `betadisper()`. Priorities are:
  1. Year-habitat as the group: include turf/cyano/everything
  2. Island side - year - habitat

```{r calculate beta dispersion}
yrBetaDisperFring <- vegan::betadisper(brayMatFring, sppMeta0fring$year) # warning: some squared distances are negative and changed to zero (ask Jamie??)

# plot of dispersion test
plot(yrBetaDisperFring, sub = "") 
boxplot(yrBetaDisperFring, main = "Fringing reef", xlab = "") 
```

### Backreef

```{r get backreef df}
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# spp matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>% 
  filter(habitat == "backreef") %>% 
  select(-year, -location, -island_side, -site, -habitat, -site_habitat, -transect, -quadrat, -AlgSum) -> sppMat0back

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>%
   filter(habitat == "backreef") %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year),
         island_side_hab_year = paste0(island_side, hab_year),
         island_side_year = paste0(island_side, year)) -> sppMeta0back
```


Calculate Bray Curtis distances

```{r calculate distance}
brayMatBack <- vegdist(sppMat0back, "bray") # 1 is maximum dissimilarity
```

Calculate beta disperion

```{r calculate beta dispersion}
yrBetaDisperBack <- vegan::betadisper(brayMatBack, sppMeta0back$year) 

# plot of dispersion test
plot(yrBetaDisperBack, sub = "") # lol
boxplot(yrBetaDisperBack, main = "Backreef", xlab = "") 
```

### Outer 10

```{r get outer 10 df}
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# spp matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>% 
  filter(habitat == "outer_10") %>% 
  select(-year, -location, -island_side, -site, -habitat, -site_habitat, -transect, -quadrat, -AlgSum) -> sppMat0outer10

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>%
   filter(habitat == "outer_10") %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year),
         island_side_hab_year = paste0(island_side, hab_year),
         island_side_year = paste0(island_side, year)) -> sppMeta0outer10
```


Calculate Bray Curtis distances

```{r calculate distance}
brayMatOuter10 <- vegdist(sppMat0outer10, "bray") # 1 is maximum dissimilarity
```

Calculate beta disperion

```{r calculate beta dispersion}
yrBetaDisperOuter10 <- vegan::betadisper(brayMatOuter10, sppMeta0outer10$year) # error: some squared distances are negative and changed to zero

# plot of dispersion test
plot(yrBetaDisperOuter10, sub = "") # lol
boxplot(yrBetaDisperOuter10, main = "Outer 10", xlab = "") 
```

### Outer 17

```{r get outer 17 df}
startAlg <- grep("acanthophora_spicifera", colnames(algae))
endAlg <- grep("valonia_ventricosa", colnames(algae))

# spp matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>% 
  filter(habitat == "outer_17") %>% 
  select(-year, -location, -island_side, -site, -habitat, -site_habitat, -transect, -quadrat, -AlgSum) -> sppMat0outer17

# metadata matrix
algae %>% 
  mutate(AlgSum = rowSums(algae[startAlg:endAlg])) %>% 
  filter(AlgSum != 0) %>%
   filter(habitat == "outer_17") %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, island_side) %>% 
  # make a year-habitat column for betadisper
  mutate(hab_year = paste0(habitat, "_", year),
         island_side_hab_year = paste0(island_side, hab_year),
         island_side_year = paste0(island_side, year)) -> sppMeta0outer17
```


Calculate Bray Curtis distances

```{r calculate distance}
brayMatOuter17 <- vegdist(sppMat0outer17, "bray") # 1 is maximum dissimilarity
```

Calculate beta disperion

```{r calculate beta dispersion}
yrBetaDisperOuter17 <- vegan::betadisper(brayMatOuter17, sppMeta0outer17$year) # error: some squared distances are negative and changed to zero

# plot of dispersion test
plot(yrBetaDisperOuter17, sub = "") # lol
boxplot(yrBetaDisperOuter17, main = "Outer 17", xlab = "") 
```

## Join together

Attach back to metadata

```{r join distances with metadata}
sppMeta0fring %>% 
  mutate(distance_centriod = yrBetaDisperFring$distances) -> fringeDist

sppMeta0back %>% 
  mutate(distance_centriod = yrBetaDisperBack$distances) -> backDist

sppMeta0outer10 %>% 
  mutate(distance_centriod = yrBetaDisperOuter10$distances) -> outer10Dist

sppMeta0outer17 %>% 
  mutate(distance_centriod = yrBetaDisperOuter17$distances) -> outer17Dist
```

```{r join together}
# make sure this looks good
colnames(fringeDist) == colnames(backDist) 
colnames(backDist) == colnames(outer10Dist) 
colnames(outer10Dist) == colnames(outer17Dist)


# join together
betaDHabYr <- rbind(fringeDist, backDist, outer10Dist, outer17Dist)
```

Confirm these produce the same plots

```{r sanity check}
betaDHabYr %>% 
  ggplot(aes(x = year, y = distance_centriod, group = year)) +
  geom_boxplot() +
  facet_wrap(~habitat)
```

Add coral data

```{r}
allbenthos %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, coral) %>% 
  # inner so that we don't add back in quadrats with 0% algae
  inner_join(betaDHabYr) -> betaDHabYrCoral
```

## Plot with coral

```{r scatter plot}
betaDHabYrCoral %>% 
  ggplot(aes(x = coral, y = distance_centriod)) +
  geom_point() +
  facet_grid(habitat ~ year)
```

```{r boxplot}
# get mean coral cover
betaDHabYrCoral %>% 
  group_by(year, habitat) %>% 
  summarize(Mean_coral = mean(coral)) %>% 
  full_join(betaDHabYrCoral) %>% 
  ggplot(aes(x = year, y = distance_centriod, group = year)) +
  geom_boxplot() +
  # Custom the Y scales:
  scale_y_continuous(
    # Features of the first axis
    name = "Algal beta diversity",
    # Add a second axis and specify its features
    sec.axis = sec_axis( trans=~.*100, name="Avg coral cover")
  ) +
  geom_line(aes(group = 1, x = year, y = Mean_coral/100), size = 2, color = "red") +
  facet_wrap(~habitat) 
```

```{r}
betaDHabYrCoral %>% 
  group_by(year, habitat) %>% 
  summarize(Mean_coral = mean(coral)) %>% 
  full_join(betaDHabYrCoral) %>% 
  ggplot(aes(group = 1, x = year, y = Mean_coral, group = year)) +
  geom_line()  +
  facet_wrap(~habitat) 
```


### Save dispersions

```{r}
# save(yrBetaDisperFring, file = here("data/fringingyrdispersion.Rdata"))
# save(yrBetaDisperBack, file = here("data/backyrdispersion.Rdata"))
# save(yrBetaDisperOuter10, file = here("data/outer10yrdispersion.Rdata"))
# save(yrBetaDisperOuter17, file = here("data/outer17yrdispersion.Rdata"))
```

### Load dispersions

```{r}
load(here("data/fringingyrdispersion.Rdata"))
load(here("data/backyrdispersion.Rdata"))
load(here("data/outer10yrdispersion.Rdata"))
load(here("data/outer17yrdispersion.Rdata"))
```


## Dispersion by island side-year-habitat

Calculate beta dispersion (do it in groups for the sake of the computer)

```{r calculate beta dispersion by habitat}
yrISBetaDisperFring <- vegan::betadisper(brayMatFring, sppMeta0fring$island_side_year) # error: some squared distances are negative and changed to zero
# save(yrISBetaDisperFring, file = here("data/fringingyrISdispersion.Rdata"))

yrISBetaDisperBack <- vegan::betadisper(brayMatBack, sppMeta0back$island_side_year)  # error: some squared distances are negative and changed to zero
# save(yrISBetaDisperBack, file = here("data/backyrISdispersion.Rdata"))

yrISBetaDisperOuter10 <- vegan::betadisper(brayMatOuter10, sppMeta0outer10$island_side_year) # error: some squared distances are negative and changed to zero
# save(yrISBetaDisperOuter10, file = here("data/outer10yrISdispersion.Rdata"))

yrISBetaDisperOuter17 <- vegan::betadisper(brayMatOuter17, sppMeta0outer17$island_side_year) # error: some squared distances are negative and changed to zero
# save(yrISBetaDisperOuter17, file = here("data/outer17yrISdispersion.Rdata"))
```

### Load dispersions

```{r}
load(here("data/fringingyrISdispersion.Rdata"))
load(here("data/backyrISdispersion.Rdata"))
load(here("data/outer10yrISdispersion.Rdata"))
load(here("data/outer17yrISdispersion.Rdata"))
```

### Join together

```{r get all distances}
# get distances
sppMeta0fring %>% 
  mutate(distance_centriod = yrISBetaDisperFring$distances) -> fringeDistIS

sppMeta0back %>% 
  mutate(distance_centriod = yrISBetaDisperBack$distances) -> backDistIS

sppMeta0outer10 %>% 
  mutate(distance_centriod = yrISBetaDisperOuter10$distances) -> outer10DistIS

sppMeta0outer17 %>% 
  mutate(distance_centriod = yrISBetaDisperOuter17$distances) -> outer17DistIS
```


```{r join together}
# make sure this looks good
colnames(fringeDistIS) == colnames(backDistIS) 
colnames(backDistIS) == colnames(outer10DistIS) 
colnames(outer10DistIS) == colnames(outer17DistIS)


# join together
betaDHabYrIS <- rbind(fringeDistIS, backDistIS, outer10DistIS, outer17DistIS)

# add coral
allbenthos %>% 
  select(year, location, site, habitat, site_habitat, transect, quadrat, coral) %>% 
  # inner so that we don't add back in quadrats with 0% algae
  inner_join(betaDHabYrIS) -> betaDHabYrISCoral
```



### Plot

```{r without coral}
betaDHabYrISCoral %>% 
  mutate(island_side = factor(island_side, levels = c("north", "east", "west")),
        habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = year, y = distance_centriod, group = year)) +
  geom_boxplot() +
  facet_grid(island_side~habitat)
```

With coral

```{r scatter plot}
betaDHabYrISCoral %>% 
  mutate(island_side = factor(island_side, levels = c("north", "east", "west")),
        habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = coral, y = distance_centriod)) +
  geom_point() +
  facet_grid(habitat ~ year)
```

```{r boxplot}
# get mean coral cover
betaDHabYrISCoral %>% 
  group_by(year, habitat, island_side) %>% 
  summarize(Mean_coral = mean(coral)) %>% 
  full_join(betaDHabYrCoral) %>% 
  mutate(island_side = factor(island_side, levels = c("north", "east", "west")),
        habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17"))) %>% 
  ggplot(aes(x = year, y = distance_centriod, group = year)) +
  geom_boxplot() +
  # Custom the Y scales:
  scale_y_continuous(
    # Features of the first axis
    name = "Algal beta diversity",
    # Add a second axis and specify its features
    sec.axis = sec_axis( trans=~.*100, name="Avg coral cover")
  ) +
  geom_line(aes(group = 1, x = year, y = Mean_coral/100), size = 2, color = "red") +
  facet_grid(island_side~habitat) 
```


# CV: Noam's way

First try looking at CV Noam's way. I think this is more looking at if diverse areas (all time) are more stable, rather than if stability from one year to the next is dictated by current diversity (I think we can do this also since quadrats are fixed--will try that next)

## Calculate

Make a coefficient of variation function:

```{r cv function}
# coefficient of variation
CV <- function(x){
  return(sd(x,na.rm=T)/mean(x,na.rm=T))
}
```

Apply it when we summarize

```{r mega quadrat df}
# get mega df with just about anything we need
coralAlgDiv %>% 
  full_join(algSum) -> megaQuadDF
```

```{r calculate CVs}
diversity_stability <- megaQuadDF %>%
  dplyr::group_by(site, habitat, site_habitat, island_side) %>%
  dplyr::summarise(
    Coral_mean = mean(coral),
    Richness_mean = mean(Richness), 
    Richness_se = sd(Richness)/sqrt(n()),
    Richness_cv = CV(Richness),
    Shannon_mean = mean(Shannon), 
    Shannon_se = sd(Shannon)/sqrt(n()),
    Shannon_cv = CV(Shannon),
    Cover_mean = mean(AlgSum),
    Cover_se = sd(AlgSum)/sqrt(n()),
    Cover_cv = CV(AlgSum))
```


## Plot

Algae diversity vs. cover CV:

```{r Shannon}
# divided by habitat
diversity_stability %>% 
  ggplot(aes(x = Shannon_mean, y = Cover_cv, color = site)) +
  geom_point() +
  facet_wrap(~habitat) +
  theme_bw()

# or all together
diversity_stability %>% 
  ggplot(aes(x = Shannon_mean, y = Cover_cv, color = site, shape = habitat)) +
  geom_point(size = 2) +
  theme_bw()
```

```{r richness}
# divided by habitat
diversity_stability %>% 
  ggplot(aes(x = Richness_mean, y = Cover_cv, color = site)) +
  geom_point() +
  facet_wrap(~habitat) +
  theme_bw()

# or all together
diversity_stability %>% 
  ggplot(aes(x = Richness_mean, y = Cover_cv, color = site, shape = habitat)) +
  geom_point(size = 2) +
  theme_bw()
```

Versus coral cover

```{r vs coral cover}
diversity_stability %>% 
  ggplot(aes(x = Coral_mean, y = Cover_cv, color = site, shape = habitat)) +
  geom_point(size = 2) +
  theme_bw()
```







# Stability

Is change in algal cover in a given quadrat from one year to the next influenced by diversity? Need to set up a lag/change to calculate this

- Would need to start in 2008 because no change to 2007

## Wrangle

Might just brute force this...

```{r get the change in algal cover each year}
megaQuadDF %>% 
  select(year, site, habitat, site_habitat, transect, quadrat, island_side, AlgSum) %>% 
  pivot_wider(names_from = year,
              values_from = AlgSum) %>% 
  # calculate changes FROM the previous year 
  # this means that a change FROM 2007 to 2008 will be joined with diversity in 2007 
  # that means that a positive correlation between richness in 2007 and "ChFrom2007" (etc) == more diverse communities are more likely to INCREASE in cover/less likely to decrease in cover (not necessarily stability)
  mutate(AlgChFrom2007 = `2008` - `2007`,
         AlgChFrom2008 = `2009` - `2008`,
         AlgChFrom2009 = `2010` - `2009`,
         AlgChFrom2010 = `2011` - `2010`,
         AlgChFrom2011 = `2012` - `2011`,
         AlgChFrom2012 = `2013` - `2012`,
         AlgChFrom2013 = `2014` - `2013`,
         AlgChFrom2014 = `2015` - `2014`,
         AlgChFrom2015 = `2016` - `2015`,
         AlgChFrom2016 = `2017` - `2016`,
         AlgChFrom2017 = `2018` - `2017`,
         AlgChFrom2018 = `2019` - `2018`,
         #AlgChFrom2007 = `2021` - `2019`, # maybe skip because this isn't comparable?
         AlgChFrom2021 = `2022` - `2021`, 
         AlgChFrom2022 = `2023` - `2022`
         ) -> algalCh
```

There are **NA's in 2021**--confirm those are just missing quadrats.

Now get it back into long/joinable format (probably a more elegant way to do this):

```{r get into long format and join}
startChA <- grep("AlgChFrom2007", colnames(algalCh))
endtChA <- grep("AlgChFrom2022", colnames(algalCh))

algalCh %>% 
  # get the columns we need
  select(c(site, habitat, site_habitat, transect, quadrat, island_side, colnames(algalCh)[startChA:endtChA])) %>% 
  pivot_longer(cols = colnames(algalCh)[startChA:endtChA],
               names_to = "Change_year",
               values_to = "Change_in_percent"
               ) %>% 
  # match with correct year
  mutate(year = case_when(
    Change_year == "AlgChFrom2007" ~ 2007,
    Change_year == "AlgChFrom2008" ~ 2008,
    Change_year == "AlgChFrom2009" ~ 2009,
    Change_year == "AlgChFrom2010" ~ 2010,
    Change_year == "AlgChFrom2011" ~ 2011,
    Change_year == "AlgChFrom2012" ~ 2012,
    Change_year == "AlgChFrom2013" ~ 2013,
    Change_year == "AlgChFrom2014" ~ 2014,
    Change_year == "AlgChFrom2015" ~ 2015,
    Change_year == "AlgChFrom2016" ~ 2016,
    Change_year == "AlgChFrom2017" ~ 2017,
    Change_year == "AlgChFrom2018" ~ 2018,
    Change_year == "AlgChFrom2019" ~ 2019,
    Change_year == "AlgChFrom2021" ~ 2021,
    Change_year == "AlgChFrom2022" ~ 2022,
    TRUE ~ -9999
  )) %>%
  full_join(megaQuadDF) %>% 
  mutate(habitat = factor(habitat, levels = c("fringing", "backreef", "outer_10", "outer_17")),
         island_side = factor(island_side, levels = c("north", "east", "west"))) -> algChYr
  
```

## Plot

```{r plot richness}
algChYr %>% 
  ggplot(aes(x = Richness, y = Change_in_percent, group = Richness)) +
  geom_boxplot() +
  theme_classic() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  facet_grid(island_side~habitat)
```

```{r plot abs(change) ~ richness}
algChYr %>% 
  ggplot(aes(x = Richness, y = abs(Change_in_percent), group = Richness)) +
  geom_boxplot() +
  theme_classic() +
  facet_grid(island_side~habitat)
```

```{r plot Shannon}
algChYr %>% 
  ggplot(aes(x = Shannon, y = Change_in_percent)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  geom_smooth() +
  theme_classic() +
  facet_grid(island_side~habitat)
```

```{r plot Shannon ~ abs(change)}
# pdf("change_in_cov_Shann.pdf", height = 7, width = 10)

algChYr %>% 
  ggplot(aes(x = Shannon, y = abs(Change_in_percent), color = year)) +
  geom_point() +
  geom_smooth(color = "coral") +
  theme_classic() + # kind of negative
  facet_grid(island_side~habitat)

# dev.off()
```





# Synchrony

Maybe try this way: https://cran.r-project.org/web/packages/codyn/vignettes/Community_Stability_Metrics.html using the `codyn` package?

```{r}

```


# Nic's plot of change through time

Want to plot how each spp changes in abundance through time just to get an idea

## Wrangling

```{r}
megaQuadDF
```





