---
title: "Manuscript 1 code"
author: "Noam Altman-Kurosaki, Callie Stephenson"
date: "2024-09-11"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(here)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(vegan)
library(glmmTMB)
library(car)
library(effects)
library(DHARMa)
library(stringr)
library(MuMIn)
library(codyn)
library(nlme)
library(mgcv)
library(emmeans)
library(dplyr)
library(janitor)
library(knitr)
library(performance)
```

## Functions
```{r}
source("R/functions.R")
```

## Figure formatting
```{r figure formatting info}
trends_theme <- theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.text.x = element_text(size = 22, angle = 45, hjust = 1),
        axis.title.y = element_text(size=24), 
        axis.text.y = element_text(size = 22),
        plot.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.text = element_text(size = rel(1)), # increase legend text
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black")) 

model_themes <-   theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend

habitat_colours <- c("Fringing" = "#D81B60",
                     "Backreef" = "#FFC107",
                     "Forereef 10m" = "#1E88E5",
                     "Forereef 17m" = "#004D40")

functional_group_colours <- c("Coral" = "darkmagenta",
                         "CCA" = "deeppink3",
                         "Macroalgae" = "chartreuse4",
                         "Turf" =  "#004D40")

```

# read and clean data

```{r read and clean data}
data <- read.csv(here::here("data", "allbenthicdata_cleaned_colnames.csv"), stringsAsFactors = F) 

### if we want to make a missing or faulty data table
# length(unique(data$location))
# expected_data <- expand.grid(year = seq(2007,2023,1), location = unique(data$location))
# missing_quadrats <- expected_data %>%
#   anti_join(data, by = c("year", "location"))
###

# remove remaining backreef and fringing 2020 data because of covid extrapolation
filtered_data <- data %>%
  filter(!(year == 2020 & habitat %in% c("fringing", "backreef")))

# re-factor for figures
filtered_data$habitat <- factor(filtered_data$habitat, 
                             levels = c("fringing", "backreef", "outer_10","outer_17"),
                             labels = c("Fringing", "Backreef", "Forereef 10m", "Forereef 17m"))

# note non-algae species
not_algae <- c("ascidian", "bare_space", "coral", "coral_rubble", "corallimorpharia", "heteractis_sp", "millepora_platyphylla", "no_data", "sand", "sarcophyton_sp", "shell_debris", "soft_coral", "sponge", "tridacna_sp", "zooxanthellae", "row_sums")


# remove
algae <- filtered_data[ , -which(names(filtered_data) %in% not_algae)]



macroalgae <- algae %>% 
  select(-algal_turf, -crustose_corallines, -cyanophyta, -damselfish_turf, -lithophyllum_kotschyanum,
         -neogoniolithon_brassica_florida, -sporolithon_sp)

meta_cols <- c("year", "location", "site", "habitat", "site_habitat", "transect", "quadrat")

meta_df <- algae[,which(names(algae) %in% meta_cols)]

algae_species_cols <- algae[,-which(names(algae) %in% meta_cols)]

macro_species_cols <- macroalgae[,-which(names(macroalgae) %in% meta_cols)]

# make long dataset
macro_long_data <- pivot_longer(
  data = macroalgae,
  cols = grep("acanthophora_spicifera", colnames(macroalgae)):grep("valonia_ventricosa", colnames(macroalgae)),
  names_to = "taxa",
  values_to = "percent_cover") %>% 
  mutate(prop_cover = percent_cover/100) %>% 
  select(-percent_cover)

# write_csv(macro_long_data, here("Data", "macro_long_data.csv"))
```


```{r site macroalgal data}
site_macro <- macroalgae %>%
  dplyr::group_by(year, site, habitat,site_habitat) %>%
  dplyr::summarize(across(acanthophora_spicifera:valonia_ventricosa, \(x) mean(x, na.rm = TRUE)))

site_meta_cols <- c("year", "site", "habitat", "site_habitat")
site_meta_df <- site_macro[,which(names(site_macro) %in% meta_cols)]
```

# Figure 1 - benthic cover trends among habitats

## setup

```{r cover plot setup}
cover_df <- data.frame(
  year = filtered_data$year,
  habitat = filtered_data$habitat,
  site = filtered_data$site,
  location = filtered_data$location,
  coral = filtered_data$coral,
  cca = filtered_data$crustose_corallines +
    filtered_data$lithophyllum_kotschyanum +
    filtered_data$neogoniolithon_brassica_florida +
    filtered_data$sporolithon_sp,
  macroalgae = rowSums(macro_species_cols),
  turf = filtered_data$algal_turf  + filtered_data$damselfish_turf, 
  sand = filtered_data$sand,
  coral_rubble = filtered_data$coral_rubble,
  cyanophyta = filtered_data$cyanophyta,
  other = filtered_data$ascidian + 
    filtered_data$corallimorpharia +
    filtered_data$heteractis_sp + 
    filtered_data$millepora_platyphylla +
    filtered_data$sarcophyton_sp + filtered_data$shell_debris +
    filtered_data$soft_coral + filtered_data$sponge + filtered_data$tridacna_sp +
    filtered_data$zooxanthellae + filtered_data$no_data + filtered_data$bare_space
)

cover_df$total <- rowSums(cover_df[,-which(names(cover_df) %in% meta_cols)])

cover_means <- cover_df %>%
  dplyr::group_by(year, habitat) %>%
  dplyr::summarise(macroalgae = mean(macroalgae),
            coral = mean(coral),
            turf = mean(turf),
            cca = mean(cca),
            sand = mean(sand),
            other = mean(other)
            )

cover_se <- cover_df %>%
  dplyr::group_by(year, habitat) %>%
  dplyr::summarise(macroalgae = se(macroalgae),
            coral = se(coral),
            turf = se(turf),
            cca = se(cca),
            sand = se(sand),
            other = se(other)
            )
```

```{r cover long}
cover_long_means <- pivot_longer(
  data = cover_means,
  cols = 3:8,
  names_to = "functional_group",
  values_to = "percent_cover"
)

cover_long_se <- pivot_longer(
  data = cover_se,
  cols = 3:8,
  names_to = "functional_group",
  values_to = "se"
)

cover_long <- left_join(cover_long_means,cover_long_se, by = join_by(year, habitat, functional_group))

#make levels of functional group for plotting
cover_long$functional_group <- factor(cover_long$functional_group, 
                             levels = c("macroalgae", "coral", "turf","cca", "sand", "other"),
                             labels = c("Macroalgae", "Coral", "Turf", "CCA", "Sand", "Other"))
```

```{r make figure1 data}
figure_1_data <- subset(cover_long, functional_group != "Sand" & functional_group != "Other")
```

## plot

```{r Figure 1, fig.height = 10, fig.width=14}
plot_list <- lapply(levels(figure_1_data$habitat), function(hab) {
  ggplot(data = subset(figure_1_data, habitat == hab)) +
    geom_point(aes(x = year, y = percent_cover, colour = functional_group), size = 3) +
    geom_errorbar(aes(x = year, ymin = percent_cover - se, ymax = percent_cover + se, colour = functional_group), 
                  width = 0, size = 1.3) +
    geom_line(aes(x = year, y = percent_cover, colour = functional_group), linewidth = 1) +
    annotate("segment", x = 2006, xend = 2010, y = 75, yend = 75, linewidth = 2, colour = "grey") +
    geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
    geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
    scale_colour_manual(values = functional_group_colours) +
    scale_x_continuous(breaks = unique(figure_1_data$year)) +
    labs(y = "Percent Cover",
         x = "Year", title = "") +  
    trends_theme
})

(figure_1 <- ggarrange(plotlist = plot_list, 
                      ncol = 2, nrow = 2, 
                      labels = c("a.", "b.", "c.", "d."),
                      common.legend = TRUE,
                      legend = "bottom", 
                      font.label = list(size = 24, color = "black", face = "plain")))


# ggsave(filename = "output/figure_1v4.png", figure_1, height = 10, width = 14)
```

# Figure 2 - macroalgal richness trends among habitats

## Create Data Frames
```{r create data for figure 2 quad}
alpha_diversity_quad_macro <-
  data.frame(
    year = macroalgae$year,
    location = macroalgae$location,
    shannon = diversity(macroalgae[, -which(names(macroalgae) %in% meta_cols)], "shannon"),
    richness = rowSums(macroalgae[, -which(names(macroalgae) %in% meta_cols)] > 0)
  )

alpha_diversity_quad_macro <- merge(meta_df, alpha_diversity_quad_macro, by = c("location", "year"))

```

```{r site level richness df}
alpha_diversity_site_macro <-
  data.frame(
    year = site_macro$year,
    site_habitat = site_macro$site_habitat,
    shannon = diversity(site_macro[ , -which(names(site_macro) %in% meta_cols)], "shannon"),
    richness = rowSums(site_macro[ , -which(names(site_macro) %in% meta_cols)] > 0)
  ) %>% 
  left_join(site_meta_df, alpha_diversity_site_macro, by = c("site_habitat", "year"))
```



```{r add cover to quad df}
macroalgal_cover_quad <- cover_df[,c("year", "habitat", "site", "location", "macroalgae")]

alpha_diversity_quad_macro <-
  left_join(alpha_diversity_quad_macro, macroalgal_cover_quad,by = join_by(location, year, site, habitat)) %>% 
  mutate(macroalgal_prop_cover = macroalgae / 100) %>% 
  select(-macroalgae)
```


```{r add cover to site df}

alpha_diversity_site_macro$percent_cover <- rowSums(site_macro[,-which(names(site_macro)  %in% colnames(site_meta_df))]) 

alpha_diversity_site_macro$prop_cover <- alpha_diversity_site_macro$percent_cover/100
  
alpha_diversity_site_macro$cover_trans <- sv_trans(alpha_diversity_site_macro$prop_cover)
```


# prep functional group data

```{r read and prep functional group data}
algae_fg_raw2 <- read_csv(here("data","algae_functional_groupings_092724.csv"))


#clean column names
algae_fg <- algae_fg_raw2 %>%
  janitor::clean_names()

#change species names to be lowercase & have underscore 
algae_fg$species <- gsub(" ", "_", tolower(algae_fg$species))
algae_fg$morphology <- trimws(algae_fg$morphology)
algae_fg$morphology <- gsub(" ", "_", algae_fg$morphology)

#rename species column to taxa

algae_fg <- algae_fg %>%
  select(species, morphology) %>%
  dplyr::rename(taxa = species) %>%
   dplyr::rename(functional_group = morphology)
 
unique(algae_fg$functional_group)

#merge functional groups  
macro_functional_groups <- merge(macro_long_data, algae_fg, all.x = TRUE)

taxa_sum_check <- macro_functional_groups %>%
  dplyr::group_by(location, year) %>%
  dplyr::summarise(sum_macrocover = sum(prop_cover))

macro_functional_groups %>%
  filter(location == "lter_2_backreef_algae_transect_1_quad_1") %>%
  filter(year == "2022")

#summarizing functional groups at the quad level
fg_summary <- macro_functional_groups %>%
  dplyr::group_by(location, year, functional_group, habitat, site) %>%
  dplyr::summarise(sum_fg_cover = sum(prop_cover))

max(fg_summary$sum_fg_cover)

#summarizing functional groups at the site level
#NOTE that this is ADDED and not averaged. This data is only used to find richness at the site level. LE did this as adding and as a sum, both end up the same from a richness perspective. 
fg_summary_site_SUM <- macro_functional_groups %>%
  dplyr::group_by(site, year, habitat, functional_group) %>%
  dplyr::summarise(sum_fg_cover = sum(prop_cover))



#QAQC
fg_summary_qaqc <- macro_functional_groups %>%
  dplyr::group_by(location, year, functional_group) %>%
  dplyr::summarise(sum_fg_cover = sum(prop_cover))

fg_qaqc <- fg_summary_qaqc %>%
  dplyr::group_by(location, year) %>%
  dplyr::summarise(sum_fg_check = sum(sum_fg_cover))
  
check_them <- merge(taxa_sum_check, fg_qaqc)

check_them %>%
  filter(all.equal(sum_macrocover, sum_fg_check) != TRUE)

#pivot wide at quad level
fg_summary_wide <- fg_summary %>%
  tidyr::pivot_wider(names_from = "functional_group", values_from = "sum_fg_cover")

#richness at every quad/year combination 
fg_summary_wide$functional_richness <- vegan::specnumber(fg_summary_wide[5:14])

unique(fg_summary_wide$functional_richness)
#0 to 4

##### REPEAT AT SITE LEVEL
#pivot wide at site level
fg_summary_site_wide_SUM <- fg_summary_site_SUM %>%
  pivot_wider(names_from = "functional_group", values_from = "sum_fg_cover")
  
#richness at every site/year combination ---> NOT AVERAGED,
fg_summary_site_wide_SUM$functional_richness <- vegan::specnumber(fg_summary_site_wide_SUM[4:13])


#merge Noam's data with functional group summary 
alpha_diversity_quad_macro <- merge(alpha_diversity_quad_macro,
                                    fg_summary_wide[,c("location", "year", "site",  "habitat", "functional_richness")],
                                    by = c("location", "year", "site", "habitat"))

#merge site level cover with site functional group richness
alpha_diversity_site_macro<-merge(alpha_diversity_site_macro,
                                  fg_summary_site_wide_SUM[,c("year", "site",  "habitat", "functional_richness")],
                                  by = c("year", "site",  "habitat"))
```

## models

### quad
```{r figure 3a richness quad model}
alpha_diversity_quad_macro$cover_trans <- sv_trans(alpha_diversity_quad_macro$macroalgal_prop_cover)

cover_mod <- glmmTMB(cover_trans ~ richness*habitat + (1|site/location) + (1|year), family = beta_family(), data = alpha_diversity_quad_macro)
summary(cover_mod)
Anova(cover_mod)
#                     Chisq Df Pr(>Chisq)    
# richness         30918.96  1  < 2.2e-16 ***
# habitat            141.68  3  < 2.2e-16 ***
# richness:habitat   294.44  3  < 2.2e-16 ***
hist(residuals(cover_mod)) # looks fine
plot(residuals(cover_mod) ~ fitted(cover_mod)) # negative trend but it can't be less than 0 so not too concerned. some wave pattern
r.squaredGLMM(cover_mod) # 0.631, 0.650
performance::r2(cover_mod) # 0.635, 0.654
emtrends(cover_mod, pairwise ~ habitat, var = "richness") # backreef not different from forereef, forereef also not different
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef          0.34715 0.0241 Inf  14.407  <.0001
# Fringing - Forereef 10m      0.34862 0.0240 Inf  14.513  <.0001
# Fringing - Forereef 17m      0.38937 0.0250 Inf  15.593  <.0001
# Backreef - Forereef 10m      0.00147 0.0205 Inf   0.072  0.9999
# Backreef - Forereef 17m      0.04223 0.0214 Inf   1.975  0.1974
# Forereef 10m - Forereef 17m  0.04076 0.0209 Inf   1.947  0.2087

```





## figure 3a plot setup
```{r figure 3a setup}


diversity_ranges_quad <- extract_ranges(alpha_diversity_quad_macro, "habitat", c("richness", "cover_trans", "functional_richness"))

cover_emm <- emmip(cover_mod,
                   habitat ~ richness,
                   at = list(richness = seq(0,10,1)), plotit = F, CIs = T)



filtered_cover_effects <- filter_ranges(trend = cover_emm, range_obj = diversity_ranges_quad, group = "habitat", value = "richness")

```

## figure 3a quad level richness versus cover

```{r figure 3a plot}
(figure_3a <- 
  ggplot() +
  geom_point(data = alpha_diversity_quad_macro,
             aes(x = richness, y = cover_trans, colour = habitat), size = 1, alpha = 0.005) + 
  geom_line(data = filtered_cover_effects, aes(x = richness, y = inv_logit(yvar), colour = habitat)) +
  geom_ribbon(data = filtered_cover_effects, aes(x = richness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.5) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Cover\n", x = "", title = "") +
  model_themes 
         )
# ggsave(filename = "output/figure_3a.png", figure_3a, height = 10, width = 14)
```

## Figure 3b - functional groups

### Setup


### model
```{r functional richness cover mod quad}


cover_mod_fg <- glmmTMB(cover_trans ~ functional_richness*habitat + (1|site/location) + (1|year), family = beta_family(), data = alpha_diversity_quad_macro)


summary(cover_mod_fg)
car::Anova(cover_mod_fg)
#                                 Chisq Df Pr(>Chisq)    
# functional_richness         31362.191  1  < 2.2e-16 ***
# habitat                        49.343  3  1.103e-10 ***
# functional_richness:habitat   451.974  3  < 2.2e-16 ***
hist(residuals(cover_mod_fg)) # good

r.squaredGLMM(cover_mod_fg) # 0.64, 0.65
performance::r2(cover_mod_fg) # 0.63, 0.65
emtrends(cover_mod_fg, pairwise ~ habitat, var = "functional_richness") 
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef            0.211 0.0266 Inf   7.937  <.0001
# Fringing - Forereef 10m        0.348 0.0262 Inf  13.285  <.0001
# Fringing - Forereef 17m        0.531 0.0262 Inf  20.280  <.0001
# Backreef - Forereef 10m        0.136 0.0231 Inf   5.888  <.0001
# Backreef - Forereef 17m        0.320 0.0232 Inf  13.812  <.0001
# Forereef 10m - Forereef 17m    0.184 0.0223 Inf   8.253  <.0001



```

## figure 3b plot setup
```{r figure 3b setup}

cover_emm_fg <- emmip(cover_mod_fg,
                        habitat ~ functional_richness,
                        at = list(functional_richness = seq(0,10,1)), plotit = F, CIs = T)

filtered_cover_effects_fg <- filter_ranges(cover_emm_fg, diversity_ranges_quad, "habitat", "functional_richness")

```

## figure 3b plot

```{r figure 3b plot}
(figure_3b <- 
  ggplot() +
  geom_point(data = alpha_diversity_quad_macro,
             aes(x = functional_richness, y = cover_trans, colour = habitat), size = 1, alpha = 0.005) + 
  geom_line(data = filtered_cover_effects_fg, aes(x = functional_richness, y = inv_logit(yvar), colour = habitat)) +
  geom_ribbon(data = filtered_cover_effects_fg, aes(x = functional_richness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "", title = "") +
  trends_theme
         )
   

#ggsave(filename = "output/figure_3b_quad_v2.png", figure_3b, height = 10, width = 14)
```

## Figure 3c

### synchrony set up
```{r calculate syncrony}


# CALCULATE SYNCHRONY CODE
lm_synchrony <- codyn::synchrony(df = macro_long_data,
                                   time.var = "year",
                                   species.var = "taxa",
                                   abundance.var = "prop_cover",
                                   metric = "Loreau",
                                   replicate.var = "location")


diversity_stability <- alpha_diversity_quad_macro %>%
  dplyr::group_by(location, habitat, site) %>%
  dplyr::summarise(
            richness_mean = mean(richness), 
            shannon_mean = mean(shannon), 
            cover_mean = mean(macroalgal_prop_cover),
            functional_richness_mean = mean(functional_richness),
            cover_cv = CV(macroalgal_prop_cover),
            cover_stability = 1/CV(macroalgal_prop_cover)) 

diversity_stability_synchrony <- left_join(diversity_stability, lm_synchrony, by = join_by(location))
diversity_stability_synchrony$synchrony_trans <- sv_trans(diversity_stability_synchrony$synchrony)


dss_ranges <- extract_ranges(diversity_stability_synchrony, "habitat",
                             c("richness_mean", "functional_richness_mean", "cover_stability", "synchrony"))


```

### synchrony and cover model

```{r synchrony cover mod}
synch_cov_mod <- glmmTMB(cover_mean ~ synchrony*habitat + (1|site), family = beta_family(), data = diversity_stability_synchrony)
summary(synch_cov_mod)
Anova(synch_cov_mod)
#                     Chisq Df Pr(>Chisq)    
# synchrony         209.521  1  < 2.2e-16 ***
# habitat            52.498  3  2.345e-11 ***
# synchrony:habitat  54.627  3  8.246e-12 ***
hist(residuals(synch_cov_mod)) # slight skew
plot(residuals(synch_cov_mod) ~ fitted(synch_cov_mod)) # same issues as always

# can't compute r2 - manually fit null model. Null model won't fit without sv_trans() for some reason
null_synch_mod <- glmmTMB(sv_trans(cover_mean) ~ 1, family = beta_family(), data = diversity_stability_synchrony)
performance::r2(model = synch_cov_mod, null_model = null_synch_mod) # 0.352, 0.534
emtrends(synch_cov_mod, pairwise ~ habitat, var = "synchrony") # forereef 17 distinct from all other habitats

# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.101 0.290 Inf   0.348  0.9856
# Fringing - Forereef 10m        0.383 0.365 Inf   1.048  0.7211
# Fringing - Forereef 17m        3.458 0.484 Inf   7.140  <.0001
# Backreef - Forereef 10m        0.282 0.378 Inf   0.746  0.8784
# Backreef - Forereef 17m        3.357 0.492 Inf   6.820  <.0001
# Forereef 10m - Forereef 17m    3.075 0.501 Inf   6.142  <.0001

```

```{r synch cov plot setup}
synch_cov_emm <- emmip(synch_cov_mod,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_cov_effects <- filter_ranges(synch_cov_emm, dss_ranges, "habitat", "synchrony")


```

### plot

```{r synchrony cover plot}
(figure_3c <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = synchrony, y = cover_mean, colour = habitat), size = 1, alpha = 0.3) + 
  geom_line(data = filtered_synch_cov_effects, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_cov_effects, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "", y = "", title = "") +
  trends_theme
         )


# ggsave(filename = "output/figure_3c.png", figure_3c, height = 10, width = 14)
```


### Synchrony setup site level
```{r calculate syncrony site_level}
# pivot longer
macro_long_data_site <- pivot_longer(
  data = site_macro,
  cols = grep("acanthophora_spicifera", colnames(site_macro)):grep("valonia_ventricosa", colnames(site_macro)),
  names_to = "taxa",
  values_to = "percent_cover") %>% 
  mutate(prop_cover = percent_cover/100) %>% 
  select(-percent_cover)

# write_csv(macro_long_data, here("Data", "macro_long_data.csv"))

# CALCULATE SYNCHRONY CODE
lm_synchrony_site <- codyn::synchrony(df = macro_long_data_site,
                                   time.var = "year",
                                   species.var = "taxa",
                                   abundance.var = "prop_cover",
                                   metric = "Loreau",
                                   replicate.var = "site_habitat")


diversity_stability_site <- alpha_diversity_site_macro %>%
  dplyr::group_by(site_habitat, habitat, site) %>%
  dplyr::summarise(
            richness_mean = mean(richness), 
            functional_richness_mean = mean(functional_richness), 
            cover_mean = mean(prop_cover),
            cover_cv = CV(prop_cover),
            cover_stability = 1/CV(prop_cover)) 

diversity_stability_synchrony_site <- left_join(diversity_stability_site, lm_synchrony_site, by = join_by(site_habitat))
diversity_stability_synchrony_site$synchrony_trans <- sv_trans(diversity_stability_synchrony_site$synchrony)

# write_csv(diversity_stability_synchrony_site, here("data", "diversity_stability_synchrony_site.csv"))

dss_ranges_site <- extract_ranges(diversity_stability_synchrony_site, "habitat",
                                  c("richness_mean", "functional_richness_mean", "cover_stability", "synchrony"))


```

## Figure 3d site level richness versus cover


### model at site level
```{r site richness mod}
site_cover_mod <- glmmTMB(cover_trans ~ richness*habitat + (1|site_habitat) + (1|year), family = beta_family(), data = alpha_diversity_site_macro)
summary(site_cover_mod)
Anova(site_cover_mod)
#                    Chisq Df Pr(>Chisq)    
# richness         58.9196  1  1.642e-14 ***
# habitat           6.6248  3    0.08487 .  
# richness:habitat  3.2966  3    0.34811    
hist(residuals(site_cover_mod)) # some positive skew, not the worst thing ever
plot(residuals(site_cover_mod) ~ fitted(site_cover_mod)) # a little heteroscedastic but can't be less than 0
r.squaredGLMM(site_cover_mod) # 0.2212534, 0.5990825
performance::r2(site_cover_mod) # 0.22, 0.59
emtrends(site_cover_mod, pairwise ~ habitat, var = "richness") # no difference between the habitats
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef          -0.0163 0.0394 Inf  -0.413  0.9762
# Fringing - Forereef 10m       0.0639 0.0503 Inf   1.271  0.5818
# Fringing - Forereef 17m       0.0334 0.0612 Inf   0.546  0.9476
# Backreef - Forereef 10m       0.0801 0.0460 Inf   1.742  0.3020
# Backreef - Forereef 17m       0.0497 0.0583 Inf   0.853  0.8289
# Forereef 10m - Forereef 17m  -0.0304 0.0651 Inf  -0.467  0.9662
```

### setup
```{r site richness cover setup}
diversity_ranges_site <- extract_ranges(alpha_diversity_site_macro, "habitat", c("richness", "functional_richness", "cover_trans"))

site_cover_emm <- emmip(site_cover_mod,
                        habitat ~ richness,
                        at = list(richness = seq(0,17,1)), plotit = F, CIs = T)

filtered_site_cover_effects <- filter_ranges(site_cover_emm, diversity_ranges_site, "habitat", "richness")



```

### plot

```{r plot figure 3d}
(figure_3d <- 
  ggplot() +
  geom_point(data = alpha_diversity_site_macro,
             aes(x = richness, y = cover_trans, colour = habitat), size = 1, alpha = 0.3) + 
  geom_line(data = filtered_site_cover_effects, aes(x = richness, y = inv_logit(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_site_cover_effects, aes(x = richness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Cover\n", x = "Macroalgal Richness", title = "") +
  trends_theme
         )
# ggsave(filename = "output/figure_3d.png", figure_3d, height = 10, width = 14)
```

## Figure 3e - functional richness at site level
### model

```{r site level fg richness model}



site_cover_mod_fg <- glmmTMB(cover_trans ~ functional_richness*habitat + (1|site_habitat) + (1|year), family = beta_family(), data = alpha_diversity_site_macro)

summary(site_cover_mod_fg)
Anova(site_cover_mod_fg)

#                               Chisq Df Pr(>Chisq)    
# functional_richness         30.3776  1  3.556e-08 ***
# habitat                      4.9314  3     0.1769    
# functional_richness:habitat  4.1429  3     0.2464    


hist(residuals(site_cover_mod_fg)) # positive skew
plot(residuals(site_cover_mod_fg) ~ fitted(site_cover_mod_fg)) # a little heteroscedastic but can't be less than 0
r.squaredGLMM(site_cover_mod_fg) # 0.180, 0.563
performance::r2(site_cover_mod_fg) # 0.180, 0.563
emtrends(site_cover_mod_fg, pairwise ~ habitat, var = "functional_richness") # no difference between the habitats
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef          -0.0163 0.0394 Inf  -0.413  0.9762
# Fringing - Forereef 10m       0.0639 0.0503 Inf   1.271  0.5818
# Fringing - Forereef 17m       0.0334 0.0612 Inf   0.546  0.9476
# Backreef - Forereef 10m       0.0801 0.0460 Inf   1.742  0.3020
# Backreef - Forereef 17m       0.0497 0.0583 Inf   0.853  0.8289
# Forereef 10m - Forereef 17m  -0.0304 0.0651 Inf  -0.467  0.9662

```
```{r site fg richness cover plot setup}

site_cover_fg_emm <- emmip(site_cover_mod_fg,
                        habitat ~ functional_richness,
                        at = list(functional_richness = seq(0,17,1)), plotit = F, CIs = T)


filtered_site_fg_cover_effects <- filter_ranges(site_cover_fg_emm, diversity_ranges_site, "habitat", "functional_richness")


```

### 3e plot

```{r figure 3e plot }
(figure_3e <- 
  ggplot() +
  geom_point(data = alpha_diversity_site_macro,
             aes(x = functional_richness, y = cover_trans, colour = habitat), size = 1, alpha = 0.3) + 
  geom_line(data = filtered_site_fg_cover_effects, aes(x = functional_richness, y = inv_logit(yvar), colour = habitat),
            size = 1.5) +
  geom_ribbon(data = filtered_site_fg_cover_effects, aes(x = functional_richness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "Functional Richness", title = "") +
  trends_theme
         )
#ggsave(filename = "output/figure_3e_v2.png", figure_3e, height = 10, width = 14)
```

## figure 3f - synchrony site level

### model

```{r synchrony cover mod}
synch_cov_mod_site <- glmmTMB(cover_mean ~ synchrony*habitat, family = beta_family(), data = diversity_stability_synchrony_site)
summary(synch_cov_mod_site)
Anova(synch_cov_mod_site)
#                    Chisq Df Pr(>Chisq)  
# synchrony         2.4156  1    0.12013  
# habitat           7.7966  3    0.05041 .
# synchrony:habitat 8.8876  3    0.03082 *
performance::r2(synch_cov_mod_site) # 0.48
hist(residuals(synch_cov_mod_site)) # slight skew
plot(residuals(synch_cov_mod_site) ~ fitted(synch_cov_mod_site)) # looks fine
emtrends(synch_cov_mod_site, pairwise ~ habitat, var = "synchrony") # forereef 17 different from backreef
# contrast                    estimate   SE  df z.ratio p.value
# Fringing - Backreef            -4.31 3.39 Inf  -1.269  0.5824
# Fringing - Forereef 10m        -0.29 3.23 Inf  -0.090  0.9997
# Fringing - Forereef 17m         3.66 3.79 Inf   0.968  0.7679
# Backreef - Forereef 10m         4.02 1.98 Inf   2.031  0.1764
# Backreef - Forereef 17m         7.97 2.80 Inf   2.848  0.0228
# Forereef 10m - Forereef 17m     3.95 2.59 Inf   1.526  0.4218
```

```{r synch cov site plot setup}
synch_cov_emm_site<- emmip(synch_cov_mod_site,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_cov_effects_site <- filter_ranges(synch_cov_emm_site, dss_ranges_site, "habitat", "synchrony")
```

### plot figure 3f

```{r synchrony cover plot site}
(figure_3f <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony_site,
             aes(x = synchrony, y = cover_mean, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_synch_cov_effects_site, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_cov_effects_site, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "Synchrony", y = "", title = "") +
  trends_theme
         )


# ggsave(filename = "output/figure_3f.png", figure_3f, height = 10, width = 14)
```

## Figure 3 Full Plot
```{r ggpubr fig3, fig.height = 8, fig.width=16}

(figure_3 <- ggarrange(figure_3a, figure_3b, figure_3c, figure_3d, figure_3e, figure_3f, 
                      ncol = 3, nrow = 2, 
                      common.legend = TRUE,
                      labels = c("a.", "b.", "c.", "d.", "e.", "f."),
                      legend = "bottom", 
                      font.label = list(size = 26, color = "black", face = "plain")))

# ggsave(filename = "output/figure_3v2.png", figure_3, height = 8, width = 16)
```

# Figure 4


## Figure 4a 

###model - richness stability

```{r richness stability mod}
rich_stab_mod <- glmmTMB(cover_stability~ richness_mean*habitat + (1|site), family = Gamma(link = "log"), data = diversity_stability_synchrony)
summary(rich_stab_mod)
Anova(rich_stab_mod)
#                          Chisq Df Pr(>Chisq)    
# richness_mean         2720.311  1  < 2.2e-16 ***
# habitat                325.657  3  < 2.2e-16 ***
# richness_mean:habitat   33.857  3  2.124e-07 ***
hist(residuals(rich_stab_mod)) # looks good
plot(residuals(rich_stab_mod) ~ fitted(rich_stab_mod)) # heteroskedastic - bring to group
r.squaredGLMM(rich_stab_mod) # 0.803, 0.808
performance::r2(rich_stab_mod) # 0.812, 0.816
emtrends(rich_stab_mod, pairwise ~ habitat, var = "richness_mean") # fringing not diff from outer17, backreef not different from outer10
# $contrasts
#  contrast                     estimate     SE  df z.ratio p.value
#  Fringing - Backreef          0.186640 0.0414 Inf   4.511  <.0001
#  Fringing - Forereef 10m      0.187248 0.0455 Inf   4.114  0.0002
#  Fringing - Forereef 17m      0.027482 0.0463 Inf   0.594  0.9340
#  Backreef - Forereef 10m      0.000608 0.0405 Inf   0.015  1.0000
#  Backreef - Forereef 17m     -0.159158 0.0411 Inf  -3.875  0.0006
#  Forereef 10m - Forereef 17m -0.159766 0.0439 Inf  -3.640  0.0016

```

```{r figure 4a setup}
rich_stab_emm <- emmip(rich_stab_mod,
                        habitat ~ richness_mean,
                        at = list(richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects <- filter_ranges(rich_stab_emm, dss_ranges, "habitat", "richness_mean")
```


### plot figure 4a

```{r figure 4a}
(figure_4a <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects, aes(x = richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects, aes(x = richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Stability\n", x = "", title = "") +
  trends_theme
         )

# ggsave(filename = "output/figure_4a.png", figure_4a, height = 10, width = 14)
```

## Figure 4b - functional group richness stability

### model
```{r fig4b fg richness stability mod}

rich_stab_mod_fg <- glmmTMB(cover_stability ~ functional_richness_mean*habitat + (1|site), family = Gamma(link = "log"), data = diversity_stability_synchrony)

summary(rich_stab_mod_fg)
car::Anova(rich_stab_mod_fg)

#                                    Chisq Df Pr(>Chisq)    
# functional_richness_mean         3082.22  1  < 2.2e-16 ***
# habitat                           116.63  3  < 2.2e-16 ***
# functional_richness_mean:habitat   25.79  3  1.055e-05 ***


hist(residuals(rich_stab_mod_fg)) # looks fine
plot(residuals(rich_stab_mod_fg) ~ fitted(rich_stab_mod_fg)) # same as usual 
r.squaredGLMM(rich_stab_mod_fg) # 0.819, 0.828
performance::r2(rich_stab_mod_fg)
emtrends(rich_stab_mod_fg, pairwise ~ habitat, var = "functional_richness_mean") 
#  fringing different from all others
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef           0.1825 0.0468 Inf   3.903  0.0006
# Fringing - Forereef 10m       0.2372 0.0518 Inf   4.575  <.0001
# Fringing - Forereef 17m       0.2045 0.0488 Inf   4.187  0.0002
# Backreef - Forereef 10m       0.0547 0.0472 Inf   1.158  0.6534
# Backreef - Forereef 17m       0.0219 0.0439 Inf   0.500  0.9592
# Forereef 10m - Forereef 17m  -0.0327 0.0475 Inf  -0.689  0.9015
#
```

```{r figure 4b plot setup}
rich_stab_emm_fg <- emmip(rich_stab_mod_fg,
                        habitat ~ functional_richness_mean,
                        at = list(functional_richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects_fg <- filter_ranges(rich_stab_emm_fg, dss_ranges, "habitat", "functional_richness_mean")
```

### plot fig 4b

```{r plot figure 4b}
(figure_4b <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = functional_richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects_fg, aes(x = functional_richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects_fg,
              aes(x = functional_richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "", title = "") +
  trends_theme
         )

#ggsave(filename = "output/figure_4b_v2.png", figure_4b, height = 10, width = 14)
```

## figure 4c 
### model -  synchrony staability

```{r synchrony staability mod}
synch_stab_mod <- glmmTMB(cover_stability ~ synchrony*habitat + (1|site), family = Gamma("log"), data = diversity_stability_synchrony)
summary(synch_stab_mod)
Anova(synch_stab_mod)
#                     Chisq Df Pr(>Chisq)    
# synchrony         1308.34  1  < 2.2e-16 ***
# habitat            103.13  3  < 2.2e-16 ***
# synchrony:habitat  327.96  3  < 2.2e-16 ***
hist(residuals(synch_stab_mod)) # looks good
plot(residuals(synch_stab_mod) ~ fitted(synch_stab_mod)) # same issue as always
r.squaredGLMM(synch_stab_mod) # 0.63, 0.71
performance::r2(synch_stab_mod) # 0.66, 0.74
emtrends(synch_stab_mod, pairwise ~ habitat, var = "synchrony") # fringing and backreef not different
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.181 0.107 Inf   1.695  0.3262
# Fringing - Forereef 10m        1.492 0.142 Inf  10.487  <.0001
# Fringing - Forereef 17m        2.436 0.149 Inf  16.336  <.0001
# Backreef - Forereef 10m        1.311 0.157 Inf   8.346  <.0001
# Backreef - Forereef 17m        2.255 0.161 Inf  14.008  <.0001
# Forereef 10m - Forereef 17m    0.944 0.181 Inf   5.222  <.0001
```

```{r figure 4c setup}
synch_stab_emm <- emmip(synch_stab_mod,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_stab_effects <- filter_ranges(synch_stab_emm, dss_ranges, "habitat", "synchrony")
```

### plot figure 4c

```{r figure 4c}
(figure_4c <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = synchrony, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_synch_stab_effects, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_stab_effects, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "", y = "", title = "") +
  trends_theme
         )
# ggsave(filename = "output/figure_4c.png", figure_4c, height = 10, width = 14)
```

## figure 4d 

###model - richness stability

```{r richness synchrony mod}
rich_stab_mod_site <- glmmTMB(cover_stability~ richness_mean*habitat, family = Gamma(link = "log"), data = diversity_stability_synchrony_site)
summary(rich_stab_mod_site)
Anova(rich_stab_mod_site)

#                        Chisq Df Pr(>Chisq)    
# richness_mean         17.645  1  2.662e-05 ***
# habitat               32.229  3  4.682e-07 ***
# richness_mean:habitat  8.075  3    0.04449 *  
hist(residuals(rich_stab_mod_site)) # blocky but fine
plot(residuals(rich_stab_mod_site) ~ fitted(rich_stab_mod_site)) # heteroskedastic - bring to group
r.squaredGLMM(rich_stab_mod_site) # 0.671
performance::r2(rich_stab_mod_site)
emtrends(rich_stab_mod_site, pairwise ~ habitat, var = "richness_mean") # no differences across habitats
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef           0.1854 0.120 Inf   1.539  0.4138
# Fringing - Forereef 10m      -0.2155 0.145 Inf  -1.484  0.4471
# Fringing - Forereef 17m      -0.2876 0.214 Inf  -1.344  0.5349
# Backreef - Forereef 10m      -0.4009 0.165 Inf  -2.432  0.0711
# Backreef - Forereef 17m      -0.4730 0.228 Inf  -2.077  0.1607
# Forereef 10m - Forereef 17m  -0.0721 0.242 Inf  -0.298  0.9908
```

```{r figure 4d setup}
rich_stab_emm_site <- emmip(rich_stab_mod_site,
                        habitat ~ richness_mean,
                        at = list(richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects_site <- filter_ranges(rich_stab_emm_site, dss_ranges_site, "habitat", "richness_mean")
```


### plot figure 4d

```{r figure 4d}
(figure_4d <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony_site,
             aes(x = richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects_site, aes(x = richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects_site, aes(x = richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Stability\n", x = "Taxonomic Richness", title = "") +
  trends_theme
         )

# ggsave(filename = "output/figure_4d.png", figure_4d, height = 10, width = 14)
```

## figure 4e

### setup and model

```{r functional group -- stability site}



rich_stab_mod_site_fg <- glmmTMB(cover_stability~ functional_richness_mean*habitat, family = Gamma(link = "log"), data = diversity_stability_site)
summary(rich_stab_mod_site_fg)
Anova(rich_stab_mod_site_fg)

# 
#                                    Chisq Df Pr(>Chisq)   
# functional_richness_mean          3.3605  1    0.06678 . 
# habitat                          12.9894  3    0.00466 **
# functional_richness_mean:habitat  7.9219  3    0.04765 * 

hist(residuals(rich_stab_mod_site_fg)) # blocky but fine
plot(residuals(rich_stab_mod_site_fg) ~ fitted(rich_stab_mod_site_fg)) # heteroskedastic
r.squaredGLMM(rich_stab_mod_site_fg) # 0.563
performance::r2(rich_stab_mod_site_fg) # 0.551
emtrends(rich_stab_mod_site_fg, pairwise ~ habitat, var = "functional_richness_mean") 
# Fringing different from outer 10
#$contrasts
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.244 0.252 Inf   0.966  0.7686
# Fringing - Forereef 10m        1.250 0.469 Inf   2.663  0.0388
# Fringing - Forereef 17m        0.354 0.280 Inf   1.264  0.5860
# Backreef - Forereef 10m        1.006 0.493 Inf   2.040  0.1735
# Backreef - Forereef 17m        0.110 0.318 Inf   0.346  0.9858
# Forereef 10m - Forereef 17m   -0.896 0.508 Inf  -1.763  0.2911
```

```{r figure 4e setup}
rich_stab_emm_site_fg <- emmip(rich_stab_mod_site_fg,
                        habitat ~ functional_richness_mean,
                        at = list(functional_richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects_site <- filter_ranges(rich_stab_emm_site_fg, dss_ranges_site, "habitat", "functional_richness_mean")

```

### plot figure 4e

```{r figure 4e}
(figure_4e <- 
  ggplot() +
  geom_point(data = diversity_stability_site,
             aes(x = functional_richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects_site, aes(x = functional_richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects_site, 
              aes(x = functional_richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "Functional Richness", title = "") +
  trends_theme
         )

#ggsave(filename = "output/figure_4e_v2.png", figure_4e, height = 10, width = 14)
```

## figure 4f

### model
```{r synchrony staability mod site}
synch_stab_mod_site <- glmmTMB(cover_stability ~ synchrony*habitat, family = Gamma("log"), data = diversity_stability_synchrony_site)
summary(synch_stab_mod_site)
Anova(synch_stab_mod_site)
#                    Chisq Df Pr(>Chisq)    
# synchrony         22.117  1  2.565e-06 ***
# habitat            9.345  3    0.02504 *  
# synchrony:habitat 10.534  3    0.01453 *   
hist(residuals(synch_stab_mod_site)) # almost uniform
plot(residuals(synch_stab_mod_site) ~ fitted(synch_stab_mod_site)) # same issue as always
r.squaredGLMM(synch_stab_mod_site) # 0.678
performance::r2(synch_stab_mod_site) # 0.702
emtrends(synch_stab_mod_site, pairwise ~ habitat, var = "synchrony") # backreef is different from forereef 17, fringing is a p = 0.05
#
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef           -0.262 0.972 Inf  -0.269  0.9932
# Fringing - Forereef 10m        1.318 0.918 Inf   1.437  0.4764
# Fringing - Forereef 17m        2.924 1.143 Inf   2.559  0.0513
# Backreef - Forereef 10m        1.580 0.857 Inf   1.843  0.2533
# Backreef - Forereef 17m        3.186 1.095 Inf   2.910  0.0189
# Forereef 10m - Forereef 17m    1.606 1.047 Inf   1.534  0.4170
```

```{r figure 4f setup}
synch_stab_emm_site <- emmip(synch_stab_mod_site,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_stab_effects_site <- filter_ranges(synch_stab_emm_site, dss_ranges_site, "habitat", "synchrony")
```

### plot figure 4f

```{r figure 4f}
(figure_4f <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony_site,
             aes(x = synchrony, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_synch_stab_effects_site, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_stab_effects_site, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "Synchrony", y = "", title = "") +
  trends_theme
         )
# ggsave(filename = "output/figure_4f.png", figure_4f, height = 10, width = 14)
```



## Figure 4 Full Plot
```{r ggpubr fig4, fig.height = 8, fig.width=16}

(figure_4 <- ggarrange(figure_4a, figure_4b, figure_4c, figure_4d, figure_4e, figure_4f, 
                      ncol = 3, nrow = 2, 
                      common.legend = TRUE,
                      heights = c(1,1),
                      widths = c(1,1,1),
                      legend = "bottom", 
                      labels = c("a.", "b.", "c.", "d.", "e.", "f."),
                      font.label = list(size = 26, color = "black", face = "plain")))

# ggsave(filename = "output/figure_4v2.png", figure_4, height = 8, width = 16)
```


# Figure 5 - spatial synchrony

## create new dfs
```{r mean and spatial synchrony}
# calculate spatial synchrony - degree to which quadrats vary together within a site
spatial_synchrony <- codyn::synchrony(df = alpha_diversity_quad_macro,
                                   time.var = "year",
                                   species.var = "location",
                                   abundance.var = "macroalgal_prop_cover",
                                   metric = "Loreau",
                                   replicate.var = "site_habitat")
colnames(spatial_synchrony) <- c("site_habitat", "spatial_synchrony") # rename to avoid overwrite

# calculate mean synchrony within a site (!= synchrony of species at the site level!)
mean_synchrony_stability <- diversity_stability_synchrony %>% 
  dplyr::group_by(habitat, site) %>% 
  dplyr::summarise(synchrony_mean = mean(synchrony, na.rm = T),
            stability_mean = mean(cover_stability, na.rm = T))

# merge with site level dss metrics
dss_spatial <- merge(diversity_stability_site, spatial_synchrony, by = "site_habitat")
dss_spatial_2 <- merge(dss_spatial, mean_synchrony_stability, by = c("habitat", "site"))

dss_spatial_ranges <- extract_ranges(dss_spatial_2, "habitat", c("spatial_synchrony", "synchrony_mean", "stability_mean"))



```


## models

### spatial synchrony
```{r model spatial synchrony}
spatial_synchrony_mod <- glmmTMB(cover_stability ~ spatial_synchrony*habitat, family = Gamma("log"), data = dss_spatial_2)
hist(residuals(spatial_synchrony_mod)) # a little skew
plot(residuals(spatial_synchrony_mod) ~ predict(spatial_synchrony_mod))
summary(spatial_synchrony_mod)
Anova(spatial_synchrony_mod)
#                             Chisq Df Pr(>Chisq)    
# spatial_synchrony         16.2942  1  5.423e-05 ***
# habitat                   19.5302  3  0.0002124 ***
# spatial_synchrony:habitat  6.7253  3  0.0811882 .  
performance::r2(spatial_synchrony_mod) # 0.64
emtrends(spatial_synchrony_mod, pairwise ~ habitat, var = "spatial_synchrony") # no sig differences but close
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.404 1.764 Inf   0.229  0.9958
# Fringing - Forereef 10m        1.365 1.754 Inf   0.778  0.8643
# Fringing - Forereef 17m        3.112 1.882 Inf   1.654  0.3484
# Backreef - Forereef 10m        0.961 0.857 Inf   1.121  0.6766
# Backreef - Forereef 17m        2.708 1.095 Inf   2.472  0.0643
# Forereef 10m - Forereef 17m    1.747 1.078 Inf   1.621  0.3667
```

```{r plot spatial synchrony}
spat_stab_emm <- emmip(spatial_synchrony_mod,
                        habitat ~ spatial_synchrony,
                        at = list(spatial_synchrony = seq(0,1,0.01)), plotit = F, CIs = T)  

filtered_spat_stab_effects <- filter_ranges(spat_stab_emm, dss_spatial_ranges, "habitat", "spatial_synchrony")


(spatial_synchrony_plot <- 
  ggplot() +
  geom_point(data = dss_spatial_2,
             aes(x = spatial_synchrony, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_spat_stab_effects, aes(x = spatial_synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_spat_stab_effects, aes(x = spatial_synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "Spatial synchrony", title = "") +
  trends_theme
         )

```

### mean synchrony
```{r mean synchrony}
mean_synchrony_mod <- glmmTMB(cover_stability ~ synchrony_mean*habitat, family = Gamma("log"), data = dss_spatial_2)
hist(residuals(mean_synchrony_mod)) # chunky
plot(residuals(mean_synchrony_mod) ~ predict(mean_synchrony_mod)) # fine
summary(mean_synchrony_mod)
Anova(mean_synchrony_mod)
#                         Chisq Df Pr(>Chisq)    
# synchrony_mean         32.914  1  9.634e-09 ***
# habitat                18.523  3  0.0003430 ***
# synchrony_mean:habitat 19.062  3  0.0002654 ***
performance::r2(mean_synchrony_mod)
emtrends(mean_synchrony_mod, pairwise ~ habitat, var = "synchrony_mean") # no sig differences but close
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            -3.26 1.503 Inf  -2.166  0.1327
# Fringing - Forereef 10m         2.22 0.995 Inf   2.231  0.1149
# Fringing - Forereef 17m         3.37 1.220 Inf   2.764  0.0291
# Backreef - Forereef 10m         5.48 1.622 Inf   3.377  0.0041
# Backreef - Forereef 17m         6.63 1.769 Inf   3.748  0.0010
# Forereef 10m - Forereef 17m     1.15 1.363 Inf   0.846  0.8322
```

```{r plot mean synchrony}
mean_synch_emm <- emmip(mean_synchrony_mod,
                        habitat ~ synchrony_mean,
                        at = list(synchrony_mean = seq(0,1,0.01)), plotit = F, CIs = T)  

filtered_mean_synch_effects <- filter_ranges(mean_synch_emm, dss_spatial_ranges, "habitat", "synchrony_mean")


(mean_synchrony_plot <- 
  ggplot() +
  geom_point(data = dss_spatial_2,
             aes(x = synchrony_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_mean_synch_effects, aes(x = synchrony_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_mean_synch_effects, aes(x = synchrony_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Site-level Stability\n", x = "Mean plot-level species synchrony", title = "") +
  trends_theme
         )
```


### mean stability plot
```{r alpha gamma stability mod plot}
alpha_gamma_stab_mod <- glmmTMB(cover_stability ~ stability_mean*habitat, family = Gamma("log"), data = dss_spatial_2)
summary(alpha_gamma_stab_mod)
Anova(alpha_gamma_stab_mod)
#                          Chisq Df Pr(>Chisq)    
# stability_mean         61.2742  1  4.965e-15 ***
# habitat                12.9328  3   0.004784 ** 
# stability_mean:habitat  9.4834  3   0.023508 * 
performance::r2(alpha_gamma_stab_mod) # 0.838

emtrends(alpha_gamma_stab_mod, pairwise ~ habitat, var = "stability_mean") # backreef different from fringe and forereef 10
# $contrasts
#  contrast                    estimate    SE  df z.ratio p.value
#  Fringing - Backreef            1.078 0.381 Inf   2.828  0.0242
#  Fringing - Forereef 10m        0.175 0.345 Inf   0.509  0.9571
#  Fringing - Forereef 17m        0.380 0.305 Inf   1.248  0.5965
#  Backreef - Forereef 10m       -0.903 0.349 Inf  -2.589  0.0474
#  Backreef - Forereef 17m       -0.698 0.309 Inf  -2.256  0.1085
#  Forereef 10m - Forereef 17m    0.205 0.263 Inf   0.779  0.8639

alpha_gamma_emm <- emmip(alpha_gamma_stab_mod,
                        habitat ~ stability_mean,
                        at = list(stability_mean = seq(0,10,0.01)), plotit = F, CIs = T)  

filtered_ag_effects <- filter_ranges(alpha_gamma_emm, dss_spatial_ranges, "habitat", "stability_mean")


(alpha_gamma_stability_plot <- 
  ggplot() +
  geom_point(data = dss_spatial_2,
             aes(x = stability_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_ag_effects, aes(x = stability_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_ag_effects, aes(x = stability_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "Plot stability", title = "") +
  trends_theme
         )
```

## panel graph
```{r figure 5 panel, fig.height = 6, fig.width=22}
(figure_5 <- ggarrange(mean_synchrony_plot, alpha_gamma_stability_plot, spatial_synchrony_plot,
                      ncol = 3, nrow = 1, 
                      common.legend = TRUE,
                      legend = "bottom", 
                      labels = c("a.", "b.", "c."),
                      font.label = list(size = 26, color = "black", face = "plain")))

# ggsave(filename = "output/figure_5_option3_v2.png", figure_5, height = 6, width = 22)
```


## Trends in richness over time

### prep
```{r richness df}
quad_richness_df <- alpha_diversity_quad_macro %>% 
  dplyr::group_by(year, habitat) %>% 
  dplyr::summarise(richness_mean = mean(richness),
            richness_se = se(richness))
```


### plot
```{r figure 2a}
(figure_s1a <- ggplot() +
  geom_point(data = quad_richness_df, aes(x = year, y = richness_mean, colour = habitat), size = 4,
             position = position_dodge(0.4)) +
  geom_line(data = quad_richness_df, aes(x = year, y = richness_mean, colour = habitat), linewidth = 1) +
  geom_errorbar(data = quad_richness_df, aes(x = year, ymin = richness_mean - richness_se, ymax = richness_mean + richness_se,
                                             colour = habitat), width = 0, size = 1.3, position = position_dodge(0.4)) +
  scale_colour_manual(values = habitat_colours) +
  annotate("segment", x = 2006, xend = 2010, y = 2, yend = 2, linewidth = 2, colour = "grey") +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(quad_richness_df$year)) +
   labs(y = "Macroalgal Richness",
        x = "Year",
        title = "") +
   trends_theme)

# ggsave(filename = "output/figure_s1a.png", figure_s1a, height = 10, width = 14)
```

## Figure 2b Richness @ Site by Year

### prep

```{r site level richness df}
site_richness_df <- alpha_diversity_site_macro %>% 
  dplyr::group_by(year, habitat) %>% 
  dplyr::summarise(richness_mean = mean(richness),
            richness_se = se(richness))

```


### plot
```{r plot figure 2b}
(figure_s1b <- ggplot() +
  geom_point(data = site_richness_df, aes(x = year, y = richness_mean, colour = habitat), size = 4,
             position = position_dodge(0.4)) +
#  geom_jitter(data = alpha_diversity_site_macro, 
#  aes(x = year, y = richness, colour = habitat, alpha = 0.05), size = 2, width = 0.4, height = 0) +
  geom_line(data = site_richness_df, aes(x = year, y = richness_mean, colour = habitat), linewidth = 1) +
  geom_errorbar(data = site_richness_df, aes(x = year, ymin = richness_mean - richness_se, ymax = richness_mean + richness_se, colour = habitat), size = 1.3, width = 0,  position = position_dodge(0.4)) +
  scale_colour_manual(values = habitat_colours) +
  annotate("segment", x = 2006, xend = 2010, y = 12, yend = 12, linewidth = 2, colour = "grey") +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(site_richness_df$year)) +
   labs(y = "",
        x = "Year",
        title = "") +
  trends_theme)

# ggsave(filename = "output/figure_s1b.png", figure_s1b, height = 10, width = 14)
```

## Figure 2 Full Plot
```{r ggpubr fig2, fig.height = 10, fig.width=22}
fig2_plot_list <- list(figure_s1a, figure_s1b)
(figure_s1 <- ggarrange(figure_s1a, figure_s1b,
                      ncol = 2, nrow = 1, 
                      labels = c("a.", "b."),
                      common.legend = TRUE,
                      legend = "bottom", 
                      font.label = list(size = 24, color = "black", face = "plain")))

# ggsave(filename = "output/figure_s1v4.png", figure_s1, height = 10, width = 22)
```

## diversity-synchrony relationships: plot level

```{r ds plot}
rich_synch_mod <- glmmTMB(synchrony_trans~ richness_mean*habitat + (1|site), family = beta_family(), data = diversity_stability_synchrony)
summary(rich_synch_mod)
Anova(rich_synch_mod)
#                         Chisq Df Pr(>Chisq)    
# richness_mean         395.416  1  < 2.2e-16 ***
# habitat               136.859  3  < 2.2e-16 ***
# richness_mean:habitat  90.031  3  < 2.2e-16 ***
hist(residuals(rich_synch_mod)) # looks good
plot(residuals(rich_synch_mod) ~ fitted(rich_synch_mod)) 
r.squaredGLMM(rich_synch_mod) # 0.71, 0.78
emtrends(rich_synch_mod, pairwise ~ habitat, var = "richness_mean") # forereefs not different from each other
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef           -0.823 0.161 Inf  -5.113  <.0001
# Fringing - Forereef 10m       -1.443 0.183 Inf  -7.879  <.0001
# Fringing - Forereef 17m       -1.628 0.187 Inf  -8.723  <.0001
# Backreef - Forereef 10m       -0.620 0.151 Inf  -4.103  0.0002
# Backreef - Forereef 17m       -0.805 0.154 Inf  -5.240  <.0001
# Forereef 10m - Forereef 17m   -0.185 0.165 Inf  -1.124  0.6745

rich_synch_emm <- emmip(rich_synch_mod,
                        habitat ~ richness_mean,
                        at = list(richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_synch_effects <- rich_synch_emm %>%
  left_join(dss_ranges, by = c("habitat")) %>%
  filter(richness_mean >= min_richness & richness_mean <= max_richness)

(rich_synch_plot <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = richness_mean, y = synchrony_trans, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_synch_effects, aes(x = richness_mean, y = inv_logit(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_synch_effects, aes(x = richness_mean, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Species synchrony\n", x = "Taxonomic richness", title = "") +
  trends_theme
         )
```