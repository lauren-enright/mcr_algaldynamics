---
title: "Manuscript 1 code"
author: "Noam Altman-Kurosaki, Callie Stephenson"
date: "2024-09-11"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
library(here)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(vegan)
library(glmmTMB)
library(car)
library(effects)
library(DHARMa)
library(stringr)
library(MuMIn)
library(codyn)
library(nlme)
library(mgcv)
library(emmeans)
library(dplyr)
library(janitor)
library(knitr)
```

## Functions
```{r}
source("R/functions.R")
```

## Figure formatting
```{r figure formatting info}
mytheme <- theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size=24), 
        plot.title = element_text(size = 24),
        panel.background = element_rect(fill = "white"), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.text = element_text(size = rel(1)), # increase legend text
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black")) 

habitat_colours <- c("Fringing" = "#D81B60",
                     "Backreef" = "#FFC107",
                     "Forereef 10m" = "#1E88E5",
                     "Forereef 17m" = "#004D40")

functional_group_colours <- c("Coral" = "darkmagenta",
                         "CCA" = "deeppink3",
                         "Macroalgae" = "chartreuse4",
                         "Turf" =  "#004D40")

```

# read and clean data

```{r read and clean data}
data <- read.csv(here::here("data", "allbenthicdata_cleaned_colnames.csv"), stringsAsFactors = F) 

### if we want to make a missing or faulty data table
# length(unique(data$location))
# expected_data <- expand.grid(year = seq(2007,2023,1), location = unique(data$location))
# missing_quadrats <- expected_data %>%
#   anti_join(data, by = c("year", "location"))
###

# remove remaining backreef and fringing 2020 data because of covid extrapolation
filtered_data <- data %>%
  filter(!(year == 2020 & habitat %in% c("fringing", "backreef")))

#THIS IS THE BIG CHANGE HERE: 9/19
filtered_data$habitat <- factor(filtered_data$habitat, 
                             levels = c("fringing", "backreef", "outer_10","outer_17"),
                             labels = c("Fringing", "Backreef", "Forereef 10m", "Forereef 17m"))

#DID NOT TOUCH BELOW:
not_algae <- c("ascidian", "bare_space", "coral", "coral_rubble", "corallimorpharia", "heteractis_sp", "millepora_platyphylla", "no_data", "sand", "sarcophyton_sp", "shell_debris", "soft_coral", "sponge", "tridacna_sp", "zooxanthellae", "row_sums")



algae <- filtered_data[ , -which(names(filtered_data) %in% not_algae)]



macroalgae <- algae %>% 
  select(-algal_turf, -crustose_corallines, -cyanophyta, -damselfish_turf, -lithophyllum_kotschyanum,
         -neogoniolithon_brassica_florida, -sporolithon_sp)

meta_cols <- c("year", "location", "site", "habitat", "site_habitat", "transect", "quadrat")

meta_df <- algae[,which(names(algae) %in% meta_cols)]

algae_species_cols <- algae[,-which(names(algae) %in% meta_cols)]

macro_species_cols <- macroalgae[,-which(names(macroalgae) %in% meta_cols)]

# make er long
macro_long_data <- pivot_longer(
  data = macroalgae,
  cols = grep("acanthophora_spicifera", colnames(macroalgae)):grep("valonia_ventricosa", colnames(macroalgae)),
  names_to = "taxa",
  values_to = "percent_cover") %>% 
  mutate(prop_cover = percent_cover/100) %>% 
  select(-percent_cover)

# write_csv(macro_long_data, here("Data", "macro_long_data.csv"))
```


```{r site macroalgal data}
site_macro <- macroalgae %>%
  dplyr::group_by(year, site, habitat,site_habitat) %>%
  dplyr::summarize(across(acanthophora_spicifera:valonia_ventricosa, \(x) mean(x, na.rm = TRUE)))

site_meta_cols <- c("year", "site", "habitat", "site_habitat")
site_meta_df <- site_macro[,which(names(site_macro) %in% meta_cols)]
```

# Figure 1 - benthic cover trends among habitats

## setup

```{r cover plot setup}
cover_df <- data.frame(
  year = filtered_data$year,
  habitat = filtered_data$habitat,
  site = filtered_data$site,
  location = filtered_data$location,
  coral = filtered_data$coral,
  cca = filtered_data$crustose_corallines +
    filtered_data$lithophyllum_kotschyanum +
    filtered_data$neogoniolithon_brassica_florida +
    filtered_data$sporolithon_sp,
  macroalgae = rowSums(macro_species_cols),
  turf = filtered_data$algal_turf  + filtered_data$damselfish_turf, 
  sand = filtered_data$sand,
  coral_rubble = filtered_data$coral_rubble,
  cyanophyta = filtered_data$cyanophyta,
  other = filtered_data$ascidian + 
    filtered_data$corallimorpharia +
    filtered_data$heteractis_sp + 
    filtered_data$millepora_platyphylla +
    filtered_data$sarcophyton_sp + filtered_data$shell_debris +
    filtered_data$soft_coral + filtered_data$sponge + filtered_data$tridacna_sp +
    filtered_data$zooxanthellae + filtered_data$no_data + filtered_data$bare_space
)

cover_df$total <- rowSums(cover_df[,-which(names(cover_df) %in% meta_cols)])

cover_means <- cover_df %>%
  group_by(year, habitat) %>%
  summarise(macroalgae = mean(macroalgae),
            coral = mean(coral),
            turf = mean(turf),
            cca = mean(cca),
            sand = mean(sand),
            other = mean(other)
            )

cover_se <- cover_df %>%
  group_by(year, habitat) %>%
  summarise(macroalgae = se(macroalgae),
            coral = se(coral),
            turf = se(turf),
            cca = se(cca),
            sand = se(sand),
            other = se(other)
            )
```

```{r cover long}
cover_long_means <- pivot_longer(
  data = cover_means,
  cols = 3:8,
  names_to = "functional_group",
  values_to = "percent_cover"
)

cover_long_se <- pivot_longer(
  data = cover_se,
  cols = 3:8,
  names_to = "functional_group",
  values_to = "se"
)

cover_long <- left_join(cover_long_means,cover_long_se, by = join_by(year, habitat, functional_group))

#make levels of functional group for plotting
cover_long$functional_group <- factor(cover_long$functional_group, 
                             levels = c("macroalgae", "coral", "turf","cca", "sand", "other"),
                             labels = c("Macroalgae", "Coral", "Turf", "CCA", "Sand", "Other"))
```

```{r make figure1 data}
figure_1_data <- subset(cover_long, functional_group != "Sand" & functional_group != "Other")
```

## plot
```{r figure 1, fig.height = 10, fig.width=14, warning=FALSE}
(figure_1 <- ggplot() +
  geom_point(data = figure_1_data, aes(x = year, y = percent_cover, colour = functional_group), size = 3) +
  geom_errorbar(data = figure_1_data, aes(x = year, ymin = percent_cover - se, ymax = percent_cover + se, colour = functional_group),
                width = 0, size = 1.3) +
   geom_line(data = figure_1_data, aes(x = year, y = percent_cover, colour = functional_group), linewidth = 1) +
  facet_wrap(~ habitat) +
  annotate("segment", x = 2006, xend = 2010, y = 75, yend = 75, linewidth = 2, colour = "grey") +
  scale_colour_manual(values = functional_group_colours) +
  # scale_fill_manual(values = functional_group_colours) +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(cover_long$year)) +
   labs(y = "Percent Cover \n",
        x = "Year") +
  theme_bw() + 
  mytheme)

# ggsave(filename = "output/figure_1.png", figure_1, height = 10, width = 14)
```

## plot after aes changes
```{r Figure 1 v2, fig.height = 10, fig.width=14}
plot_list <- lapply(levels(figure_1_data$habitat), function(hab) {
  ggplot(data = subset(figure_1_data, habitat == hab)) +
    geom_point(aes(x = year, y = percent_cover, colour = functional_group), size = 3) +
    geom_errorbar(aes(x = year, ymin = percent_cover - se, ymax = percent_cover + se, colour = functional_group), 
                  width = 0, size = 1.3) +
    geom_line(aes(x = year, y = percent_cover, colour = functional_group), linewidth = 1) +
    annotate("segment", x = 2006, xend = 2010, y = 75, yend = 75, linewidth = 2, colour = "grey") +
    geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
    geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
    scale_colour_manual(values = functional_group_colours) +
    scale_x_continuous(breaks = unique(figure_1_data$year)) +
    labs(y = "Percent Cover",
         x = "Year",
         title = hab) +  # Add habitat as title
    theme_bw() +
    mytheme
})

(figure_1 <- ggarrange(plotlist = plot_list, 
                      ncol = 2, nrow = 2, 
                      labels = c("a.", "b.", "c.", "d."),
                      common.legend = TRUE,
                      legend = "bottom", 
                      font.label = list(size = 24, color = "black", face = "plain")))
# 
# figure_1_caption <- "Figure 1. Benthic coverage of four major space holders in Moorea across four habitats (Fringing, Backreef, Forereef at 10m depth, Forereef  at 17m depth). Annual fluctuations in percent cover of macroalgae, coral, turf, and crustose coralline algae (CCA) are displayed as points for the average cover for each benthic group across sites at each habitat with lines showing standard error. Dotted lines show disturbance events for Cyclone Oli (2010) in black, and the 2019 bleaching event in red, and the gray horizontal line shows crown of thorns (COTs) outbreak which occurred from 2007-2010."
# 
# figure_1_with_caption <- annotate_figure(figure_1,
#                 bottom = text_grob(figure_1_caption, hjust = 0.5, vjust = 1, size = 10))

# ggsave(filename = "output/figure_1v3.png", figure_1, height = 10, width = 14)
```

# Figure 2 - macroalgal richness trends among habitats

## Create Data Frames
```{r create data for figure 2 quad}
alpha_diversity_quad_macro <-
  data.frame(
    year = macroalgae$year,
    location = macroalgae$location,
    shannon = diversity(macroalgae[, -which(names(macroalgae) %in% meta_cols)], "shannon"),
    richness = rowSums(macroalgae[, -which(names(macroalgae) %in% meta_cols)] > 0)
  )

#JG Add Evenness
alpha_diversity_quad_macro$ev <- alpha_diversity_quad_macro$shannon /
  (log(alpha_diversity_quad_macro$richness))

#makes 1 species 0 and 0 species NA for evenness metric
alpha_diversity_quad_macro$evenness <- ifelse(
  alpha_diversity_quad_macro$richness == 0,
  NA,
  # If richness == 0, ev is NA
  ifelse(
    alpha_diversity_quad_macro$richness == 1,
    0,
    # If richness == 1, ev is 0
    alpha_diversity_quad_macro$ev
  )
)  

alpha_diversity_quad_macro <- merge(meta_df, alpha_diversity_quad_macro, by = c("location", "year"))
```

```{r site level richness df}
alpha_diversity_site_macro <-
  data.frame(
    year = site_macro$year,
    site_habitat = site_macro$site_habitat,
    shannon = diversity(site_macro[ , -which(names(site_macro) %in% meta_cols)], "shannon"),
    richness = rowSums(site_macro[ , -which(names(site_macro) %in% meta_cols)] > 0)
  ) %>% 
  left_join(site_meta_df, alpha_diversity_site_macro, by = c("site_habitat", "year"))
```

```{r site level evenness}
#JG Add Evenness
alpha_diversity_site_macro$ev <- alpha_diversity_site_macro$shannon /
  (log(alpha_diversity_site_macro$richness))

#makes 1 species 0 and 0 species NA for evenness metric
alpha_diversity_site_macro$evenness <- ifelse(
  alpha_diversity_site_macro$richness == 0,
  NA,
  # If richness == 0, ev is NA
  ifelse(
    alpha_diversity_site_macro$richness == 1,
    0,
    # If richness == 1, ev is 0
    alpha_diversity_site_macro$ev
  )
)  

alpha_diversity_site_macro <- left_join(site_meta_df, alpha_diversity_site_macro,by = join_by(year, site, habitat, site_habitat))
```

```{r add cover to quad df}
macroalgal_cover_quad <- cover_df[,c("year", "habitat", "site", "location", "macroalgae")]

alpha_diversity_quad_macro <-
  left_join(alpha_diversity_quad_macro, macroalgal_cover_quad,by = join_by(location, year, site, habitat)) %>% 
  mutate(macroalgal_prop_cover = macroalgae / 100) %>% 
  select(-macroalgae)
```


## Figure 2a Richness @ Quad by Year

### prep
```{r richness df}
quad_richness_df <- alpha_diversity_quad_macro %>% 
  group_by(year, habitat) %>% 
  summarise(richness_mean = mean(richness),
            richness_se = se(richness))
```


### plot
```{r figure 2a}
(figure_2a <- ggplot() +
  geom_point(data = quad_richness_df, aes(x = year, y = richness_mean, colour = habitat), size = 4,
             position = position_dodge(0.4)) +
  geom_line(data = quad_richness_df, aes(x = year, y = richness_mean, colour = habitat), linewidth = 1) +
  geom_errorbar(data = quad_richness_df, aes(x = year, ymin = richness_mean - richness_se, ymax = richness_mean + richness_se,
                                             colour = habitat), width = 0, size = 1.3, position = position_dodge(0.4)) +
  scale_colour_manual(values = habitat_colours) +
  # scale_fill_manual(values = habitat_colours) +
  #geom_segment(aes(y = 75, yend = 75, x = 2006, xend = 2010), linewidth = 2, colour = "grey") +
  annotate("segment", x = 2006, xend = 2010, y = 2, yend = 2, linewidth = 2, colour = "grey") +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(quad_richness_df$year)) +
   labs(y = "Macroalgal Richness",
        x = "Year",
        title = "Quadrat-level Richness") +
  theme_bw() + 
  mytheme +
   theme(axis.text.x = element_text(size=20),
         axis.title.x = element_text(size=22),
         axis.title.y = element_text(size=22),
      axis.text.y = element_text(size=20),
      plot.title = element_text(size=24),
      legend.text = element_text(size=20),
      legend.title = element_blank()))

# ggsave(filename = "output/figure_2a.png", figure_2a, height = 10, width = 14)
```

## Figure 2b Richness @ Site by Year

### prep

```{r site level richness df}
site_richness_df <- alpha_diversity_site_macro %>% 
  group_by(year, habitat) %>% 
  summarise(richness_mean = mean(richness),
            richness_se = se(richness))

```


### plot
```{r plot figure 2b}
(figure_2b <- ggplot() +
  geom_point(data = site_richness_df, aes(x = year, y = richness_mean, colour = habitat), size = 4,
             position = position_dodge(0.4)) +
#  geom_jitter(data = alpha_diversity_site_macro, 
#  aes(x = year, y = richness, colour = habitat, alpha = 0.05), size = 2, width = 0.4, height = 0) +
  geom_line(data = site_richness_df, aes(x = year, y = richness_mean, colour = habitat), linewidth = 1) +
  geom_errorbar(data = site_richness_df, aes(x = year, ymin = richness_mean - richness_se, ymax = richness_mean + richness_se, colour = habitat), size = 1.3, width = 0,  position = position_dodge(0.4)) +
  scale_colour_manual(values = habitat_colours) +
  #geom_segment(aes(y = 75, yend = 75, x = 2006, xend = 2010), linewidth = 2, colour = "grey") +
  annotate("segment", x = 2006, xend = 2010, y = 12, yend = 12, linewidth = 2, colour = "grey") +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(site_richness_df$year)) +
   labs(y = "",
        x = "Year",
        title = "Site-level Richness") +
  mytheme +
   theme(axis.text.x = element_text(size=20),
         axis.title.x = element_text(size=22),
      axis.text.y = element_text(size=20),
      plot.title = element_text(size=24),
      legend.text = element_text(size=20),
      legend.title = element_blank(),
      ))

# ggsave(filename = "output/figure_2b.png", figure_2b, height = 10, width = 14)
```

## Figure 2 Full Plot
```{r ggpubr fig2, fig.height = 10, fig.width=22}
fig2_plot_list <- list(figure_2a, figure_2b)
(figure_2 <- ggarrange(plotlist = fig2_plot_list, 
                      ncol = 2, nrow = 1, 
                      labels = c("a.", "b."),
                      common.legend = TRUE,
                      legend = "bottom", 
                      font.label = list(size = 24, color = "black", face = "plain")))

# ggsave(filename = "output/figure_2v3.png", figure_2, height = 10, width = 22)
```


# Figure 3 - ecosystem function




## models

### quad
```{r figure 3a richness quad model}
alpha_diversity_quad_macro$cover_trans <- sv_trans(alpha_diversity_quad_macro$macroalgal_prop_cover)

cover_mod <- glmmTMB(cover_trans ~ richness*habitat + (1|site/location) + (1|year), family = beta_family(), data = alpha_diversity_quad_macro)
summary(cover_mod)
Anova(cover_mod)
#                     Chisq Df Pr(>Chisq)    
# richness         30916.73  1  < 2.2e-16 ***
# habitat            141.78  3  < 2.2e-16 ***
# richness:habitat   294.54  3  < 2.2e-16 ***
hist(residuals(cover_mod)) # looks fine
plot(residuals(cover_mod) ~ fitted(cover_mod)) # negative trend but it can't be less than 0 so not too concerned. some wave pattern
r.squaredGLMM(cover_mod) # 0.631, 0.650
emtrends(cover_mod, pairwise ~ habitat, var = "richness") # backreef not different from forereef, forereef also not different
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef          0.34720 0.0241 Inf  14.409  <.0001
# Fringing - Forereef 10m      0.34865 0.0240 Inf  14.514  <.0001
# Fringing - Forereef 17m      0.38953 0.0250 Inf  15.599  <.0001
# Backreef - Forereef 10m      0.00144 0.0205 Inf   0.071  0.9999
# Backreef - Forereef 17m      0.04232 0.0214 Inf   1.979  0.1957
# Forereef 10m - Forereef 17m  0.04088 0.0209 Inf   1.952  0.2063
```





## figure 3a plot setup
```{r figure 3a setup}
diversity_ranges_quad <- alpha_diversity_quad_macro %>%
  group_by(habitat) %>%
  summarise(min_richness = min(richness),
            max_richness = max(richness),
            min_cover= min(cover_trans),
            max_cover = max(cover_trans))

cover_emm <- emmip(cover_mod,
                        habitat ~ richness,
                        at = list(richness = seq(0,10,1)), plotit = F, CIs = T)

filtered_cover_effects <- cover_emm %>%
  left_join(diversity_ranges_quad, by = c("habitat")) %>%
  filter(richness >= min_richness & richness <= max_richness)

```

## figure 3a quad level richness versus cover

```{r figure 3a plot}
(figure_3a <- 
  ggplot() +
  geom_point(data = alpha_diversity_quad_macro,
             aes(x = richness, y = cover_trans, colour = habitat), size = 1, alpha = 0.005) + 
  geom_line(data = filtered_cover_effects, aes(x = richness, y = inv_logit(yvar), colour = habitat)) +
  geom_ribbon(data = filtered_cover_effects, aes(x = richness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.5) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Cover\n", x = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
# ggsave(filename = "output/figure_3a.png", figure_3a, height = 10, width = 14)
```

## Figure 3b - functional groups

### Setup
```{r read and prep functional group data}
algae_fg_raw2 <- read_csv(here("data","algae_functional_groupings_092724.csv"))


#clean column names
algae_fg <- algae_fg_raw2 %>%
  janitor::clean_names()

#change species names to be lowercase & have underscore 
algae_fg$species <- gsub(" ", "_", tolower(algae_fg$species))
algae_fg$morphology <- trimws(algae_fg$morphology)
algae_fg$morphology <- gsub(" ", "_", algae_fg$morphology)

#rename species column to taxa

algae_fg <- algae_fg %>%
  select(species, morphology) %>%
  dplyr::rename(taxa = species) %>%
   dplyr::rename(functional_group = morphology)
 
unique(algae_fg$functional_group)

#merge functional groups  
macro_functional_groups <- merge(macro_long_data, algae_fg, all.x = TRUE)

taxa_sum_check <- macro_functional_groups %>%
  group_by(location, year) %>%
  summarise(sum_macrocover = sum(prop_cover))

macro_functional_groups %>%
  filter(location == "lter_2_backreef_algae_transect_1_quad_1") %>%
  filter(year == "2022")

#summarizing functional groups at the quad level
fg_summary <- macro_functional_groups %>%
  group_by(location, year, functional_group, habitat, site) %>%
  summarise(sum_fg_cover = sum(prop_cover))

max(fg_summary$sum_fg_cover)

#summarizing functional groups at the site level
#NOTE that this is ADDED and not averaged. This data is only used to find richness at the site level. LE did this as adding and as a sum, both end up the same from a richness perspective. 
fg_summary_site_SUM <- macro_functional_groups %>%
  group_by(site, year, habitat, functional_group) %>%
  summarise(sum_fg_cover = sum(prop_cover))



#QAQC
fg_summary_qaqc <- macro_functional_groups %>%
  group_by(location, year, functional_group) %>%
  summarise(sum_fg_cover = sum(prop_cover))

fg_qaqc <- fg_summary_qaqc %>%
  group_by(location, year) %>%
  summarise(sum_fg_check = sum(sum_fg_cover))
  
check_them <- merge(taxa_sum_check, fg_qaqc)

check_them %>%
  filter(all.equal(sum_macrocover, sum_fg_check) != TRUE)

#pivot wide at quad level
fg_summary_wide <- fg_summary %>%
  pivot_wider(names_from = "functional_group", values_from = "sum_fg_cover")

#richness at every quad/year combination 
fg_summary_wide$fg_richness_quad <- vegan::specnumber(fg_summary_wide[5:14])

unique(fg_summary_wide$fg_richness_quad)
#0 to 4

##### REPEAT AT SITE LEVEL
#pivot wide at site level
fg_summary_site_wide_SUM <- fg_summary_site_SUM %>%
  pivot_wider(names_from = "functional_group", values_from = "sum_fg_cover")
  
#richness at every site/year combination ---> NOT AVERAGED,
fg_summary_site_wide_SUM$fg_richness_site <- vegan::specnumber(fg_summary_site_wide_SUM[4:13])

fg_summary_site_wide <- fg_summary_site_wide_SUM 
```

### model
```{r functional richness cover mod quad}
#merge Noam's data with functional group summary 
functional_richness_quad_cover <- merge(alpha_diversity_quad_macro, fg_summary_wide,
                                        by = c("location", "year", "site", "habitat"))

cover_mod_fg <- glmmTMB(cover_trans ~ fg_richness_quad*habitat + (1|site/location) + (1|year), family = beta_family(), data = functional_richness_quad_cover)


summary(cover_mod_fg)
car::Anova(cover_mod_fg)
#                              Chisq Df Pr(>Chisq)    
# fg_richness_quad         31341.052  1  < 2.2e-16 ***
# habitat                     49.887  3  8.444e-11 ***
# fg_richness_quad:habitat   447.780  3  < 2.2e-16 ***
hist(residuals(cover_mod_fg)) # good

r.squaredGLMM(cover_mod_fg) # 0.64, 0.65
emtrends(cover_mod_fg, pairwise ~ habitat, var = "fg_richness_quad") 
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef            0.214 0.0266 Inf   8.051  <.0001
# Fringing - Forereef 10m        0.346 0.0261 Inf  13.252  <.0001
# Fringing - Forereef 17m        0.530 0.0262 Inf  20.244  <.0001
# Backreef - Forereef 10m        0.132 0.0231 Inf   5.708  <.0001
# Backreef - Forereef 17m        0.316 0.0232 Inf  13.617  <.0001
# Forereef 10m - Forereef 17m    0.184 0.0223 Inf   8.241  <.0001



```

## figure 3b plot setup
```{r figure 3b setup}
diversity_ranges_quad_fg <- functional_richness_quad_cover %>%
  group_by(habitat) %>%
  summarise(min_fg_richness_quad = min(fg_richness_quad),
            max_fg_richness_quad = max(fg_richness_quad),
            min_cover= min(cover_trans),
            max_cover = max(cover_trans))

cover_emm_fg <- emmip(cover_mod_fg,
                        habitat ~ fg_richness_quad,
                        at = list(fg_richness_quad = seq(0,10,1)), plotit = F, CIs = T)

filtered_cover_effects_fg <- cover_emm_fg %>%
  left_join(diversity_ranges_quad_fg, by = c("habitat")) %>%
  filter(fg_richness_quad >= min_fg_richness_quad & fg_richness_quad <= max_fg_richness_quad)

```

## figure 3b plot

```{r figure 3b plot}
(figure_3b <- 
  ggplot() +
  geom_point(data = functional_richness_quad_cover,
             aes(x = fg_richness_quad, y = cover_trans, colour = habitat), size = 1, alpha = 0.005) + 
  geom_line(data = filtered_cover_effects_fg, aes(x = fg_richness_quad, y = inv_logit(yvar), colour = habitat)) +
  geom_ribbon(data = filtered_cover_effects_fg, aes(x = fg_richness_quad, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
   

#ggsave(filename = "output/figure_3b_quad_v2.png", figure_3b, height = 10, width = 14)
```

## Figure 3c

### synchrony set up
```{r calculate syncrony}


# CALCULATE SYNCHRONY CODE
lm_synchrony <- codyn::synchrony(df = macro_long_data,
                                   time.var = "year",
                                   species.var = "taxa",
                                   abundance.var = "prop_cover",
                                   metric = "Loreau",
                                   replicate.var = "location")


diversity_stability <- alpha_diversity_quad_macro %>%
  dplyr::group_by(location, habitat, site) %>%
  dplyr::summarise(
            richness_mean = mean(richness), 
            shannon_mean = mean(shannon), 
            cover_mean = mean(macroalgal_prop_cover),
            evenness_mean = mean(evenness, na.rm = T),
            cover_cv = CV(macroalgal_prop_cover),
            cover_stability = 1/CV(macroalgal_prop_cover)) 

diversity_stability_synchrony <- left_join(diversity_stability, lm_synchrony, by = join_by(location))
diversity_stability_synchrony$synchrony_trans <- sv_trans(diversity_stability_synchrony$synchrony)



dss_ranges<- diversity_stability_synchrony %>%
  group_by(habitat) %>%
  summarise(min_richness = min(richness_mean),
            max_richness = max(richness_mean),
            min_evenness = min(richness_mean, na.rm = TRUE),
            max_evenness = max(richness_mean, na.rm = TRUE),
            min_stability= min(cover_stability, na.rm = TRUE),
            max_stability = max(cover_stability, na.rm = TRUE),
            min_synchrony = min(synchrony_trans, na.rm = TRUE),
            max_synchrony = max(synchrony_trans, na.rm = TRUE))
```

### synchrony and cover model

```{r synchrony cover mod}
synch_cov_mod <- glmmTMB(cover_mean ~ synchrony*habitat + (1|site), family = beta_family(), data = diversity_stability_synchrony)
summary(synch_cov_mod)
Anova(synch_cov_mod)
#                     Chisq Df Pr(>Chisq)    
# synchrony         209.545  1  < 2.2e-16 ***
# habitat            52.512  3  2.330e-11 ***
# synchrony:habitat  54.632  3  8.227e-12 ***
hist(residuals(synch_cov_mod)) # slight skew
plot(residuals(synch_cov_mod) ~ fitted(synch_cov_mod)) # same issues as always

r.squaredGLMM(synch_cov_mod) # error??
emtrends(synch_cov_mod, pairwise ~ habitat, var = "synchrony") # forereef 17 distinct from all other habitats

# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.101 0.290 Inf   0.348  0.9856
# Fringing - Forereef 10m        0.383 0.365 Inf   1.048  0.7211
# Fringing - Forereef 17m        3.458 0.484 Inf   7.140  <.0001
# Backreef - Forereef 10m        0.282 0.378 Inf   0.746  0.8784
# Backreef - Forereef 17m        3.357 0.492 Inf   6.820  <.0001
# Forereef 10m - Forereef 17m    3.075 0.501 Inf   6.142  <.0001

```

```{r synch cov plot setup}
synch_cov_emm <- emmip(synch_cov_mod,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_cov_effects <- synch_cov_emm %>%
  left_join(dss_ranges, by = c("habitat")) %>%
  filter(synchrony >= min_synchrony & synchrony <= max_synchrony)
```

### plot

```{r synchrony cover plot}
(figure_3c <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = synchrony, y = cover_mean, colour = habitat), size = 1, alpha = 0.3) + 
  geom_line(data = filtered_synch_cov_effects, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_cov_effects, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "", y = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )


# ggsave(filename = "output/figure_3c.png", figure_3c, height = 10, width = 14)
```


### Synchrony setup site level
```{r calculate syncrony site_level}
# make er long
macro_long_data_site <- pivot_longer(
  data = site_macro,
  cols = grep("acanthophora_spicifera", colnames(site_macro)):grep("valonia_ventricosa", colnames(site_macro)),
  names_to = "taxa",
  values_to = "percent_cover") %>% 
  mutate(prop_cover = percent_cover/100) %>% 
  select(-percent_cover)

# write_csv(macro_long_data, here("Data", "macro_long_data.csv"))

# CALCULATE SYNCHRONY CODE
lm_synchrony_site <- codyn::synchrony(df = macro_long_data_site,
                                   time.var = "year",
                                   species.var = "taxa",
                                   abundance.var = "prop_cover",
                                   metric = "Loreau",
                                   replicate.var = "site_habitat")


diversity_stability_site <- alpha_diversity_site_macro %>%
  dplyr::group_by(site_habitat, habitat, site) %>%
  dplyr::summarise(
            richness_mean = mean(richness), 
            shannon_mean = mean(shannon), 
            cover_mean = mean(prop_cover),
            evenness_mean = mean(evenness),
            cover_cv = CV(prop_cover),
            cover_stability = 1/CV(prop_cover)) 

diversity_stability_synchrony_site <- left_join(diversity_stability_site, lm_synchrony_site, by = join_by(site_habitat))
diversity_stability_synchrony_site$synchrony_trans <- sv_trans(diversity_stability_synchrony_site$synchrony)

# write_csv(diversity_stability_synchrony_site, here("data", "diversity_stability_synchrony_site.csv"))

dss_ranges_site <- diversity_stability_synchrony_site %>%
  group_by(habitat) %>%
  summarise(min_richness = min(richness_mean),
            max_richness = max(richness_mean),
            min_evenness = min(evenness_mean, na.rm = T),
            max_evenness = max(evenness_mean, na.rm = T),
            min_stability= min(cover_stability),
            max_stability = max(cover_stability),
            min_synchrony = min(synchrony_trans),
            max_synchrony = max(synchrony_trans))
```

## Figure 3d site level richness versus cover

## set up site-level data for model
```{r site cover by diversity data setup}

alpha_diversity_site_macro$percent_cover <- rowSums(site_macro[,-which(names(site_macro)  %in% colnames(site_meta_df))]) 

alpha_diversity_site_macro$prop_cover <- alpha_diversity_site_macro$percent_cover/100
  
alpha_diversity_site_macro$cover_trans <- sv_trans(alpha_diversity_site_macro$prop_cover)
```

### model at site level
```{r site richness mod}
site_cover_mod <- glmmTMB(cover_trans ~ richness*habitat + (1|site_habitat) + (1|year), family = beta_family(), data = alpha_diversity_site_macro)
summary(site_cover_mod)
Anova(site_cover_mod)
#                    Chisq Df Pr(>Chisq)    
# richness         58.9195  1  1.643e-14 ***
# habitat           6.6247  3    0.08487 .  
# richness:habitat  3.2967  3    0.34811    
hist(residuals(site_cover_mod)) # some positive skew, not the worst thing ever
plot(residuals(site_cover_mod) ~ fitted(site_cover_mod)) # a little heteroscedastic but can't be less than 0
r.squaredGLMM(site_cover_mod) # 0.2212534, 0.5990825
emtrends(site_cover_mod, pairwise ~ habitat, var = "richness") # no difference between the habitats
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef          -0.0163 0.0394 Inf  -0.413  0.9762
# Fringing - Forereef 10m       0.0639 0.0503 Inf   1.271  0.5818
# Fringing - Forereef 17m       0.0334 0.0612 Inf   0.546  0.9476
# Backreef - Forereef 10m       0.0801 0.0460 Inf   1.742  0.3020
# Backreef - Forereef 17m       0.0497 0.0583 Inf   0.853  0.8289
# Forereef 10m - Forereef 17m  -0.0304 0.0651 Inf  -0.467  0.9662
```

### setup
```{r site richness cover setup}
diversity_ranges_site <- alpha_diversity_site_macro %>%
  group_by(habitat) %>%
  summarise(min_richness = min(richness),
            max_richness = max(richness),
            min_cover= min(cover_trans),
            max_cover = max(cover_trans))

site_cover_emm <- emmip(site_cover_mod,
                        habitat ~ richness,
                        at = list(richness = seq(0,17,1)), plotit = F, CIs = T)

filtered_site_cover_effects <- site_cover_emm %>%
  left_join(diversity_ranges_site, by = c("habitat")) %>%
  filter(richness >= min_richness & richness <= max_richness)

```

### plot

```{r plot figure 3d}
(figure_3d <- 
  ggplot() +
  geom_point(data = alpha_diversity_site_macro,
             aes(x = richness, y = cover_trans, colour = habitat), size = 1, alpha = 0.3) + 
  geom_line(data = filtered_site_cover_effects, aes(x = richness, y = inv_logit(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_site_cover_effects, aes(x = richness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Cover\n", x = "Macroalgal Richness", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
# ggsave(filename = "output/figure_3d.png", figure_3d, height = 10, width = 14)
```

## Figure 3e - functional richness at site level
### model

```{r site level fg richness model}
#merge site level cover with site functional group richness

functional_richness_site_cover<- merge(alpha_diversity_site_macro, fg_summary_site_wide,
                                by = c("year", "site",  "habitat"))


site_cover_mod_fg <- glmmTMB(cover_trans ~ fg_richness_site*habitat + (1|site_habitat) + (1|year), family = beta_family(), data = functional_richness_site_cover)

summary(site_cover_mod_fg)
Anova(site_cover_mod_fg)

#                            Chisq Df Pr(>Chisq)    
# fg_richness_site         30.9412  1   2.66e-08 ***
# habitat                   4.8929  3     0.1798    
# fg_richness_site:habitat  4.2193  3     0.2387  


hist(residuals(site_cover_mod_fg)) # positive skew
plot(residuals(site_cover_mod_fg) ~ fitted(site_cover_mod_fg)) # a little heteroscedastic but can't be less than 0
r.squaredGLMM(site_cover_mod_fg) # 0.180, 0.563
emtrends(site_cover_mod_fg, pairwise ~ habitat, var = "fg_richness_site") # no difference between the habitats
# Fringing - Backreef           0.0379 0.0825 Inf   0.459  0.9679
# Fringing - Forereef 10m       0.1846 0.0930 Inf   1.985  0.1935
# Fringing - Forereef 17m       0.0933 0.0960 Inf   0.972  0.7655
# Backreef - Forereef 10m       0.1467 0.0986 Inf   1.488  0.4447
# Backreef - Forereef 17m       0.0554 0.1018 Inf   0.545  0.9480
# Forereef 10m - Forereef 17m  -0.0913 0.1093 Inf  -0.835  0.8377

```
```{r site fg richness cover plot setup}
fg_ranges_site <- functional_richness_site_cover %>%
  group_by(habitat) %>%
  summarise(min_fg_richness_site = min(fg_richness_site),
            max_fg_richness_site = max(fg_richness_site),
            min_cover= min(cover_trans),
            max_cover = max(cover_trans))

site_cover_fg_emm <- emmip(site_cover_mod_fg,
                        habitat ~ fg_richness_site,
                        at = list(fg_richness_site = seq(0,17,1)), plotit = F, CIs = T)

filtered_site_fg_cover_effects <- site_cover_fg_emm %>%
  left_join(fg_ranges_site, by = c("habitat")) %>%
  filter(fg_richness_site >= min_fg_richness_site & fg_richness_site <= max_fg_richness_site)
```

### 3e plot

```{r figure 3e plot }
(figure_3e <- 
  ggplot() +
  geom_point(data = functional_richness_site_cover,
             aes(x = fg_richness_site, y = cover_trans, colour = habitat), size = 1, alpha = 0.3) + 
  geom_line(data = filtered_site_fg_cover_effects, aes(x = fg_richness_site, y = inv_logit(yvar), colour = habitat),
            size = 1.5) +
  geom_ribbon(data = filtered_site_fg_cover_effects, aes(x = fg_richness_site, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "Functional Richness", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
#ggsave(filename = "output/figure_3e_v2.png", figure_3e, height = 10, width = 14)
```

## figure 3f - synchrony site level

### model

```{r synchrony cover mod}
synch_cov_mod_site <- glmmTMB(cover_mean ~ synchrony*habitat, family = beta_family(), data = diversity_stability_synchrony_site)
summary(synch_cov_mod_site)
Anova(synch_cov_mod_site)
#                    Chisq Df Pr(>Chisq)  
# synchrony         2.4184  1    0.11992  
# habitat           7.8002  3    0.05033 .
# synchrony:habitat 8.8866  3    0.03084 *
hist(residuals(synch_cov_mod_site)) # slight skew
plot(residuals(synch_cov_mod_site) ~ fitted(synch_cov_mod_site)) # looks fine
emtrends(synch_cov_mod_site, pairwise ~ habitat, var = "synchrony") # forereef 17 different from backreef
# contrast                    estimate   SE  df z.ratio p.value
# Fringing - Backreef           -4.299 3.38 Inf  -1.270  0.5821
# Fringing - Forereef 10m       -0.279 3.22 Inf  -0.087  0.9998
# Fringing - Forereef 17m        3.675 3.78 Inf   0.973  0.7649
# Backreef - Forereef 10m        4.019 1.98 Inf   2.031  0.1764
# Backreef - Forereef 17m        7.973 2.80 Inf   2.848  0.0228
# Forereef 10m - Forereef 17m    3.954 2.59 Inf   1.526  0.4217
```

```{r synch cov site plot setup}
synch_cov_emm_site<- emmip(synch_cov_mod_site,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_cov_effects_site <- synch_cov_emm_site %>%
  left_join(dss_ranges_site, by = c("habitat")) %>%
  filter(synchrony >= min_synchrony & synchrony <= max_synchrony)
```

### plot figure 3f

```{r synchrony cover plot site}
(figure_3f <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony_site,
             aes(x = synchrony, y = cover_mean, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_synch_cov_effects_site, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_cov_effects_site, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "Synchrony", y = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )


# ggsave(filename = "output/figure_3f.png", figure_3f, height = 10, width = 14)
```

## Figure 3 Full Plot
```{r ggpubr fig3, fig.height = 8, fig.width=16}

(figure_3 <- ggarrange(figure_3a, figure_3b, figure_3c, figure_3d, figure_3e, figure_3f, 
                      ncol = 3, nrow = 2, 
                      common.legend = TRUE,
                      labels = c("a.", "b.", "c.", "d.", "e.", "f."),
                      legend = "bottom", 
                      font.label = list(size = 26, color = "black", face = "plain")))

# ggsave(filename = "output/figure_3v2.png", figure_3, height = 8, width = 16)
```

# Figure 4


## Figure 4a 

###model - richness stability

```{r richness synchrony mod}
rich_stab_mod <- glmmTMB(cover_stability~ richness_mean*habitat + (1|site), family = Gamma(link = "log"), data = diversity_stability_synchrony)
summary(rich_stab_mod)
Anova(rich_stab_mod)
#                          Chisq Df Pr(>Chisq)    
# richness_mean         2721.438  1  < 2.2e-16 ***
# habitat                325.876  3  < 2.2e-16 ***
# richness_mean:habitat   33.926  3  2.054e-07 ***
hist(residuals(rich_stab_mod)) # looks good
plot(residuals(rich_stab_mod) ~ fitted(rich_stab_mod)) # heteroskedastic - bring to group
r.squaredGLMM(rich_stab_mod) # 0.803, 0.808
emtrends(rich_stab_mod, pairwise ~ habitat, var = "richness_mean") # fringing not diff from outer17, backreef not different from outer10
# contrast                     estimate     SE  df z.ratio p.value
# Fringing - Backreef          0.186670 0.0414 Inf   4.512  <.0001
# Fringing - Forereef 10m      0.187196 0.0455 Inf   4.114  0.0002
# Fringing - Forereef 17m      0.027112 0.0463 Inf   0.586  0.9364
# Backreef - Forereef 10m      0.000525 0.0405 Inf   0.013  1.0000
# Backreef - Forereef 17m     -0.159559 0.0411 Inf  -3.885  0.0006
# Forereef 10m - Forereef 17m -0.160084 0.0439 Inf  -3.647  0.0015
```

```{r figure 4a setup}
rich_stab_emm <- emmip(rich_stab_mod,
                        habitat ~ richness_mean,
                        at = list(richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects <- rich_stab_emm %>%
  left_join(dss_ranges, by = c("habitat")) %>%
  filter(richness_mean >= min_richness & richness_mean <= max_richness)
```


### plot figure 4a

```{r figure 4a}
(figure_4a <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects, aes(x = richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects, aes(x = richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Stability\n", x = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

# ggsave(filename = "output/figure_4a.png", figure_4a, height = 10, width = 14)
```

#### no habitat

```{r richness stability no hab}
# rich_stab_mod_2 <- glmmTMB(cover_stability~ richness_mean + (1|site), family = Gamma(link = "log"), data = # diversity_stability_synchrony)
# summary(rich_stab_mod_2)
# hist(residuals(rich_stab_mod_2)) # a chunkier version
# plot(residuals(rich_stab_mod_2) ~ fitted(rich_stab_mod_2)) # heteroskedastic - bring to group
# r.squaredGLMM(rich_stab_mod_2) # 0.750, 0.757


```

```{r 4a no hab setup}
# rich_stab_emm_2 <-as.data.frame(emmeans(rich_stab_mod_2, ~richness_mean,
#                                      at = list(richness_mean = seq(min(diversity_stability_synchrony$richness_mean),
#                                                             max(diversity_stability_synchrony$richness_mean),
#                                                             0.01)))) 
# 
```

#### no habitat plot

```{r figure 4a no habitat}
# (figure_4a_no_hab <- 
#   ggplot() +
#   geom_point(data = diversity_stability_synchrony,
#              aes(x = richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
#   geom_line(data = filtered_rich_stab_effects, aes(x = richness_mean, y = exp(yvar), colour = habitat)) +
#   geom_ribbon(data = filtered_rich_stab_effects, aes(x = richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
#               alpha = 0.3) +
#   geom_line(data = rich_stab_emm_2, aes(x = richness_mean, y = exp(emmean)), size = 2, colour = "black") +
#   geom_ribbon(data = rich_stab_emm_2, aes(x = richness_mean, ymin = exp(asymp.LCL), ymax = exp(asymp.UCL)), fill = "black",
#               alpha = 0.3) +
#   scale_colour_manual(values = habitat_colours) +
#   scale_fill_manual(values = habitat_colours) +
#   labs(y = "Stability\n", x = "Macroalgal Richness") +
#   theme_bw() + 
#   theme(axis.title.x = element_text(size=18), 
#         axis.title.y = element_text(size=18), 
#         panel.background = element_blank(), 
#         panel.grid.major = element_blank(),  #remove major-grid labels
#         panel.grid.minor = element_blank(),  #remove minor-grid labels
#         plot.background = element_rect(fill = "white"),
#         legend.text = element_text(size = rel(1)), # increase legend text
#         legend.title = element_blank(),
#         legend.position = 'bottom', # move legend to bottom
#         legend.box = 'horizontal', # make legend horizontal
#         legend.box.background = element_rect(colour = "black"))  # add box around legend
#          )
# 
# ggsave(filename = "output/figure_4a_with_no_hab.png", figure_4a_no_hab, height = 10, width = 14)
```

## Figure 4b - functional group richness stability
### Setup
```{r functional richness through time at quad level}
fg_summary_wide_meta <- merge(fg_summary_wide, meta_df, by = c("location", "site", "habitat", "year") )
fg_summary_wide_meta_through_time <- fg_summary_wide_meta %>%
  group_by(location, habitat, site) %>%
  summarise(fg_richness_mean = mean(fg_richness_quad),
            fg_richness_se = sd(fg_richness_quad)/n())



#merge with fg data 
fg_stability_quad_level <- merge(fg_summary_wide_meta_through_time, diversity_stability_synchrony, 
                              by = 
                                c("location","site", "habitat"))

dss_ranges_fg <- fg_stability_quad_level %>%
  group_by(habitat) %>%
  summarise(min_richness_fg = min(fg_richness_mean),
            max_richness_fg = max(fg_richness_mean),
            min_stability= min(cover_stability, na.rm = TRUE),
            max_stability = max(cover_stability, na.rm = TRUE))
```

### figure 4b model
```{r fig4b fg richness stability mod}

rich_stab_mod_fg <- glmmTMB(cover_stability ~ fg_richness_mean*habitat + (1|site), family = Gamma(link = "log"), data = fg_stability_quad_level)

summary(rich_stab_mod_fg)
car::Anova(rich_stab_mod_fg)

#                             Chisq Df Pr(>Chisq)    
# fg_richness_mean         3079.229  1  < 2.2e-16 ***
# habitat                   118.605  3  < 2.2e-16 ***
# fg_richness_mean:habitat   25.692  3  1.107e-05 ***


hist(residuals(rich_stab_mod_fg)) # looks fine
plot(residuals(rich_stab_mod_fg) ~ fitted(rich_stab_mod_fg)) # same as usual 
r.squaredGLMM(rich_stab_mod_fg) # 0.819, 0.828
emtrends(rich_stab_mod_fg, pairwise ~ habitat, var = "fg_richness_mean") 
#  fringing different from all others
# contrast                    estimate     SE  df z.ratio p.value
# Fringing - Backreef           0.1872 0.0468 Inf   3.999  0.0004
# Fringing - Forereef 10m       0.2348 0.0519 Inf   4.524  <.0001
# Fringing - Forereef 17m       0.2040 0.0489 Inf   4.173  0.0002
# Backreef - Forereef 10m       0.0477 0.0472 Inf   1.011  0.7432
# Backreef - Forereef 17m       0.0169 0.0439 Inf   0.385  0.9806
# Forereef 10m - Forereef 17m  -0.0308 0.0475 Inf  -0.648  0.9164
#
```

```{r figure 4b plot setup}
rich_stab_emm_fg <- emmip(rich_stab_mod_fg,
                        habitat ~ fg_richness_mean,
                        at = list(fg_richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects_fg <- rich_stab_emm_fg %>%
  left_join(dss_ranges_fg, by = c("habitat")) %>%
  filter(fg_richness_mean >= min_richness_fg & fg_richness_mean <= max_richness_fg)
```

### plot fig 4b

```{r plot figure 4b}
(figure_4b <- 
  ggplot() +
  geom_point(data = fg_stability_quad_level,
             aes(x = fg_richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects_fg, aes(x = fg_richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects_fg, aes(x = fg_richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

#ggsave(filename = "output/figure_4b_v2.png", figure_4b, height = 10, width = 14)
```

## figure 4c 
### model -  synchrony staability

```{r synchrony staability mod}
synch_stab_mod <- glmmTMB(cover_stability ~ synchrony*habitat + (1|site), family = Gamma("log"), data = diversity_stability_synchrony)
summary(synch_stab_mod)
Anova(synch_stab_mod)
#                     Chisq Df Pr(>Chisq)    
# synchrony         1308.33  1  < 2.2e-16 ***
# habitat            103.13  3  < 2.2e-16 ***
# synchrony:habitat  327.97  3  < 2.2e-16 ***
hist(residuals(synch_stab_mod)) # looks good
plot(residuals(synch_stab_mod) ~ fitted(synch_stab_mod)) # same issue as always
r.squaredGLMM(synch_stab_mod) # 0.63, 0.71
emtrends(synch_stab_mod, pairwise ~ habitat, var = "synchrony") # fringing and backreef not different
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.181 0.107 Inf   1.695  0.3262
# Fringing - Forereef 10m        1.492 0.142 Inf  10.487  <.0001
# Fringing - Forereef 17m        2.436 0.149 Inf  16.336  <.0001
# Backreef - Forereef 10m        1.311 0.157 Inf   8.346  <.0001
# Backreef - Forereef 17m        2.255 0.161 Inf  14.008  <.0001
# Forereef 10m - Forereef 17m    0.944 0.181 Inf   5.222  <.0001
```

```{r figure 4c setup}
synch_stab_emm <- emmip(synch_stab_mod,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_stab_effects <- synch_stab_emm %>%
  left_join(dss_ranges, by = c("habitat")) %>%
  filter(synchrony >= min_synchrony & synchrony <= max_synchrony)
```

### plot figure 4c

```{r figure 4c}
(figure_4c <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony,
             aes(x = synchrony, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_synch_stab_effects, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_stab_effects, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "", y = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
# ggsave(filename = "output/figure_4c.png", figure_4c, height = 10, width = 14)
```

## figure 4d 

###model - richness stability

```{r richness synchrony mod}
rich_stab_mod_site <- glmmTMB(cover_stability~ richness_mean*habitat, family = Gamma(link = "log"), data = diversity_stability_synchrony_site)
summary(rich_stab_mod_site)
Anova(rich_stab_mod_site)

#                        Chisq Df Pr(>Chisq)    
# richness_mean         17.645  1  2.662e-05 ***
# habitat               32.229  3  4.682e-07 ***
# richness_mean:habitat  8.075  3    0.04449 *  
hist(residuals(rich_stab_mod_site)) # blocky but fine
plot(residuals(rich_stab_mod_site) ~ fitted(rich_stab_mod_site)) # heteroskedastic - bring to group
r.squaredGLMM(rich_stab_mod_site) # 0.671
emtrends(rich_stab_mod_site, pairwise ~ habitat, var = "richness_mean") # no differences across habitats
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef           0.1854 0.120 Inf   1.539  0.4138
# Fringing - Forereef 10m      -0.2155 0.145 Inf  -1.484  0.4471
# Fringing - Forereef 17m      -0.2876 0.214 Inf  -1.344  0.5349
# Backreef - Forereef 10m      -0.4009 0.165 Inf  -2.432  0.0711
# Backreef - Forereef 17m      -0.4730 0.228 Inf  -2.077  0.1607
# Forereef 10m - Forereef 17m  -0.0721 0.242 Inf  -0.298  0.9908
```

```{r figure 4d setup}
rich_stab_emm_site <- emmip(rich_stab_mod_site,
                        habitat ~ richness_mean,
                        at = list(richness_mean = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects_site <- rich_stab_emm_site %>%
  left_join(dss_ranges_site, by = c("habitat")) %>%
  filter(richness_mean >= min_richness & richness_mean <= max_richness)
```


### plot figure 4d

```{r figure 4d}
(figure_4d <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony_site,
             aes(x = richness_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects_site, aes(x = richness_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects_site, aes(x = richness_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Stability\n", x = "Taxonomic Richness", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

# ggsave(filename = "output/figure_4d.png", figure_4d, height = 10, width = 14)
```

## figure 4e

### setup and model

```{r functional group -- stability site}


#need to get average functional richness through time! 
fg_summary_site_wide_summary <- fg_summary_site_wide %>%
  group_by(habitat, site) %>%
  summarize(avg_richness_fg = mean(fg_richness_site),
            se_richness_fg = sd(fg_richness_site)/sqrt(n()))

#n = 24! 

# merge
stability_site_level_fg <- merge(diversity_stability_synchrony_site, fg_summary_site_wide_summary, by = c("site", "habitat"))

# extract relevant ranges for plotting
dss_ranges_site_fg_stab <- stability_site_level_fg %>%
  group_by(habitat) %>%
  summarise(min_richness_fg = min(avg_richness_fg),
            max_richness_fg = max(avg_richness_fg),
            min_stability= min(cover_stability),
            max_stability = max(cover_stability))



rich_stab_mod_site_fg <- glmmTMB(cover_stability~ avg_richness_fg*habitat, family = Gamma(link = "log"), data = stability_site_level_fg)
summary(rich_stab_mod_site_fg)
Anova(rich_stab_mod_site_fg)

#                           Chisq Df Pr(>Chisq)   
# avg_richness_fg          3.4019  1   0.065122 . 
# habitat                 12.8194  3   0.005044 **
# avg_richness_fg:habitat  7.9921  3   0.046176 * 

hist(residuals(rich_stab_mod_site_fg)) # blocky but fine
plot(residuals(rich_stab_mod_site_fg) ~ fitted(rich_stab_mod_site_fg)) # heteroskedastic
r.squaredGLMM(rich_stab_mod_site_fg) # 0.563
emtrends(rich_stab_mod_site_fg, pairwise ~ habitat, var = "avg_richness_fg") 
# Fringing different from outer 10
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef           0.2552 0.254 Inf   1.005  0.7463
# Fringing - Forereef 10m       1.2611 0.469 Inf   2.686  0.0364
# Fringing - Forereef 17m       0.3543 0.287 Inf   1.235  0.6045
# Backreef - Forereef 10m       1.0059 0.492 Inf   2.044  0.1720
# Backreef - Forereef 17m       0.0991 0.323 Inf   0.307  0.9900
# Forereef 10m - Forereef 17m  -0.9068 0.510 Inf  -1.778  0.2838
```

```{r figure 4e setup}
rich_stab_emm_site_fg <- emmip(rich_stab_mod_site_fg,
                        habitat ~ avg_richness_fg,
                        at = list(avg_richness_fg = seq(0,10,0.01)), plotit = F, CIs = T)

filtered_rich_stab_effects_site <- rich_stab_emm_site_fg %>%
  left_join(dss_ranges_site_fg_stab, by = c("habitat")) %>%
  filter((avg_richness_fg >= min_richness_fg) & (avg_richness_fg <= max_richness_fg))

```

### plot figure 4e

```{r figure 4e}
(figure_4e <- 
  ggplot() +
  geom_point(data = stability_site_level_fg,
             aes(x = avg_richness_fg, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_rich_stab_effects_site, aes(x = avg_richness_fg, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_rich_stab_effects_site, aes(x = avg_richness_fg, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "", x = "Functional Richness", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

#ggsave(filename = "output/figure_4e_v2.png", figure_4e, height = 10, width = 14)
```

## figure 4f

### model
```{r synchrony staability mod site}
synch_stab_mod_site <- glmmTMB(cover_stability ~ synchrony*habitat, family = Gamma("log"), data = diversity_stability_synchrony_site)
summary(synch_stab_mod_site)
Anova(synch_stab_mod_site)
#                     Chisq Df Pr(>Chisq)    
# synchrony         22.0686  1  2.631e-06 ***
# habitat            9.3333  3    0.02517 *  
# synchrony:habitat 10.5561  3    0.01439 *  
hist(residuals(synch_stab_mod_site)) # almost uniform
plot(residuals(synch_stab_mod_site) ~ fitted(synch_stab_mod_site)) # same issue as always
r.squaredGLMM(synch_stab_mod_site) # 0.678
emtrends(synch_stab_mod_site, pairwise ~ habitat, var = "synchrony") # backreef is different from forereef 17, fringing is a p = 0.05
#
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef           -0.256 0.971 Inf  -0.263  0.9936
# Fringing - Forereef 10m        1.324 0.916 Inf   1.445  0.4709
# Fringing - Forereef 17m        2.930 1.142 Inf   2.567  0.0503
# Backreef - Forereef 10m        1.580 0.858 Inf   1.842  0.2534
# Backreef - Forereef 17m        3.186 1.095 Inf   2.909  0.0190
# Forereef 10m - Forereef 17m    1.606 1.047 Inf   1.534  0.4172
```

```{r figure 4f setup}
synch_stab_emm_site <- emmip(synch_stab_mod_site,
                        habitat ~ synchrony,
                        at = list(synchrony = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_synch_stab_effects_site <- synch_stab_emm_site %>%
  left_join(dss_ranges_site, by = c("habitat")) %>%
  filter(synchrony >= min_synchrony & synchrony <= max_synchrony)
```

### plot figure 4f

```{r figure 4f}
(figure_4f <- 
  ggplot() +
  geom_point(data = diversity_stability_synchrony_site,
             aes(x = synchrony, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_synch_stab_effects_site, aes(x = synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_synch_stab_effects_site, aes(x = synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(x = "Synchrony", y = "", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
# ggsave(filename = "output/figure_4f.png", figure_4f, height = 10, width = 14)
```



## Figure 4 Full Plot
```{r ggpubr fig4, fig.height = 8, fig.width=16}

(figure_4 <- ggarrange(figure_4a, figure_4b, figure_4c, figure_4d, figure_4e, figure_4f, 
                      ncol = 3, nrow = 2, 
                      common.legend = TRUE,
                      heights = c(1,1),
                      widths = c(1,1,1),
                      legend = "bottom", 
                      labels = c("a.", "b.", "c.", "d.", "e.", "f."),
                      font.label = list(size = 26, color = "black", face = "plain")))

# ggsave(filename = "output/figure_4v2.png", figure_4, height = 8, width = 16)
```


# Figure 5 - spatial synchrony

## create new dfs
```{r mean and spatial synchrony}
# calculate spatial synchrony - degree to which quadrats vary together within a site
spatial_synchrony <- codyn::synchrony(df = alpha_diversity_quad_macro,
                                   time.var = "year",
                                   species.var = "location",
                                   abundance.var = "macroalgal_prop_cover",
                                   metric = "Loreau",
                                   replicate.var = "site_habitat")
colnames(spatial_synchrony) <- c("site_habitat", "spatial_synchrony") # rename to avoid overwrite

# calculate mean synchrony within a site (!= synchrony of species at the site level!)
mean_synchrony <- diversity_stability_synchrony %>% 
  group_by(habitat, site) %>% 
  summarise(synchrony_mean = mean(synchrony))

# merge with site level dss metrics
dss_spatial <- merge(diversity_stability_site, spatial_synchrony, by = "site_habitat")
dss_spatial_2 <- merge(dss_spatial, mean_synchrony, by = c("habitat", "site"))

dss_spatial_ranges <- dss_spatial_2 %>%
  group_by(habitat) %>%
  summarise(min_spatial_synchrony = min(dss_spatial_2$spatial_synchrony, na.rm = TRUE),
            max_spatial_synchrony = max(dss_spatial_2$spatial_synchrony, na.rm = TRUE),
            min_mean_synchrony= min(synchrony_mean, na.rm = TRUE),
            max_mean_synchrony = max(synchrony_mean, na.rm  = TRUE))
  

```


## models
```{r model spatial synchrony}
spatial_synchrony_mod <- glmmTMB(cover_stability ~ spatial_synchrony*habitat, family = Gamma("log"), data = dss_spatial_2)
hist(residuals(spatial_synchrony_mod)) # a little skew
plot(residuals(spatial_synchrony_mod) ~ predict(spatial_synchrony_mod))
summary(spatial_synchrony_mod)
Anova(spatial_synchrony_mod)
#                             Chisq Df Pr(>Chisq)    
# spatial_synchrony         16.2914  1  5.431e-05 ***
# habitat                   19.5303  3  0.0002124 ***
# spatial_synchrony:habitat  6.7239  3  0.0812368 .  
emtrends(spatial_synchrony_mod, pairwise ~ habitat, var = "spatial_synchrony") # no sig differences but close
# contrast                    estimate    SE  df z.ratio p.value
# Fringing - Backreef            0.404 1.765 Inf   0.229  0.9958
# Fringing - Forereef 10m        1.365 1.754 Inf   0.778  0.8643
# Fringing - Forereef 17m        3.112 1.882 Inf   1.654  0.3484
# Backreef - Forereef 10m        0.961 0.857 Inf   1.121  0.6766
# Backreef - Forereef 17m        2.708 1.095 Inf   2.472  0.0644
# Forereef 10m - Forereef 17m    1.747 1.078 Inf   1.621  0.3668
```
```{r plot spatial synchrony}
spat_stab_emm <- emmip(spatial_synchrony_mod,
                        habitat ~ spatial_synchrony,
                        at = list(spatial_synchrony = seq(0,1,0.01)), plotit = F, CIs = T)  

filtered_spat_stab_effects <- spat_stab_emm %>%
  left_join(dss_spatial_ranges, by = c("habitat")) %>%
  filter(spatial_synchrony >= min_spatial_synchrony & 
           spatial_synchrony <= max_spatial_synchrony)


(figure_5a <- 
  ggplot() +
  geom_point(data = dss_spatial_2,
             aes(x = spatial_synchrony, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_spat_stab_effects, aes(x = spatial_synchrony, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_spat_stab_effects, aes(x = spatial_synchrony, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Stability\n", x = "Spatial synchrony", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

```
```{r mean synchrony}
mean_synchrony_mod <- glmmTMB(cover_stability ~ synchrony_mean*habitat, family = Gamma("log"), data = dss_spatial_2)
hist(residuals(mean_synchrony_mod)) # chunky
plot(residuals(mean_synchrony_mod) ~ predict(mean_synchrony_mod)) # heteroskedastic
summary(mean_synchrony_mod)
Anova(mean_synchrony_mod)
#                         Chisq Df Pr(>Chisq)    
# synchrony_mean         30.134  1  4.031e-08 ***
# habitat                22.008  3  6.498e-05 ***
# synchrony_mean:habitat 17.251  3  0.0006275 ***
emtrends(mean_synchrony_mod, pairwise ~ habitat, var = "synchrony_mean") # no sig differences but close
# contrast                    estimate   SE  df z.ratio p.value
# Fringing - Backreef            -2.75 1.79 Inf  -1.538  0.4147
# Fringing - Forereef 10m         2.57 1.05 Inf   2.444  0.0691
# Fringing - Forereef 17m         3.73 1.27 Inf   2.946  0.0170
# Backreef - Forereef 10m         5.33 1.85 Inf   2.875  0.0211
# Backreef - Forereef 17m         6.48 1.98 Inf   3.271  0.0059
# Forereef 10m - Forereef 17m     1.15 1.35 Inf   0.853  0.8287
```
```{r plot mean synchrony}
mean_synch_emm <- emmip(mean_synchrony_mod,
                        habitat ~ synchrony_mean,
                        at = list(synchrony_mean = seq(0,1,0.01)), plotit = F, CIs = T)  

filtered_mean_synch_effects <- mean_synch_emm %>%
  left_join(dss_spatial_ranges, by = c("habitat")) %>%
  filter(synchrony_mean >= min_spatial_synchrony & 
           synchrony_mean <= max_spatial_synchrony)


(figure_5b <- 
  ggplot() +
  geom_point(data = dss_spatial_2,
             aes(x = synchrony_mean, y = cover_stability, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_mean_synch_effects, aes(x = synchrony_mean, y = exp(yvar), colour = habitat), size = 1.5) +
  geom_ribbon(data = filtered_mean_synch_effects, aes(x = synchrony_mean, ymin = exp(LCL), ymax = exp(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Stability\n", x = "Mean synchrony", title = "") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=24), 
        axis.title.y = element_text(size=24), 
        axis.text.x = element_text(size=22), 
        axis.text.y = element_text(size=22),
        legend.text = element_text(size=22),
        plot.title = element_text(size=26), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )
```

## panel graph
```{r figure 5 panel, fig.height = 8, fig.width=16}
(figure_5 <- ggarrange(figure_5a, figure_5b, 
                      ncol = 2, nrow = 1, 
                      common.legend = TRUE,
                      legend = "bottom", 
                      labels = c("a.", "b."),
                      font.label = list(size = 26, color = "black", face = "plain")))

# ggsave(filename = "output/figure_5.png", figure_5, height = 8, width = 16)
```

# SUPPLEMENTAL FIGURE CODE:

## 2c Evenness @ Quad by Year
### prep
```{r calculate evennes}
#dear callie, why is this here?
site_richness_df <- alpha_diversity_site_macro %>% 
  group_by(year, habitat) %>% 
  summarise(richness_mean = mean(richness),
            richness_se = se(richness))

quad_evenness_df <- alpha_diversity_quad_macro %>% 
  drop_na(evenness) %>%
  group_by(year, habitat) %>% 
  summarise(evenness_mean = mean(evenness),
            evenness_se = se(evenness))
```

### plot
```{r}
(figure_2c <- ggplot() +
  geom_point(data = quad_evenness_df, aes(x = year, y = evenness_mean, colour = habitat), size = 3) +
  geom_line(data = quad_evenness_df, aes(x = year, y = evenness_mean, colour = habitat), linewidth = 1) +
  geom_errorbar(data = quad_evenness_df, aes(x = year, ymin = evenness_mean - evenness_se, ymax = evenness_mean + evenness_se,
                                             colour = habitat), width = 0, size = 1.3) +
  scale_colour_manual(values = habitat_colours) +
  # scale_fill_manual(values = habitat_colours) +
  #geom_segment(aes(y = 75, yend = 75, x = 2006, xend = 2010), linewidth = 2, colour = "grey") +
  annotate("segment", x = 2006, xend = 2010, y = .7, yend = .7, linewidth = 2, colour = "grey") +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(quad_evenness_df$year)) +
   labs(y = "Macroalgal evenness \n",
        x = "Year",
        title = "c. Quadrat-level evenness") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=18), 
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size=18), 
        plot.title = element_text(size=18),
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.text = element_text(size = rel(1)), # increase legend text
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black")) )

# ggsave(filename = "output/figure_2c.png", figure_2c, height = 10, width = 14)
```

## 2d Evenness @ Site by Year
### prep
```{r set up evenness}
site_evenness_df <- alpha_diversity_site_macro %>% 
  drop_na(evenness) %>%
  group_by(year, habitat) %>% 
  summarise(evenness_mean = mean(evenness),
            evenness_se = se(evenness))
```

### plot
```{r plot evenness site}
(figure_2d <- ggplot() +
  geom_point(data = site_evenness_df, aes(x = year, y = evenness_mean, colour = habitat), size = 3) +
  geom_line(data = site_evenness_df, aes(x = year, y = evenness_mean, colour = habitat), linewidth = 1) +
  geom_errorbar(data = site_evenness_df, aes(x = year, ymin = evenness_mean - evenness_se, ymax = evenness_mean + evenness_se, colour = habitat), size = 1.3, width = 0) +
  scale_colour_manual(values = habitat_colours) +
  #geom_segment(aes(y = 75, yend = 75, x = 2006, xend = 2010), linewidth = 2, colour = "grey") +
  annotate("segment", x = 2006, xend = 2010, y = 1, yend = 1, linewidth = 2, colour = "grey") +
  geom_vline(xintercept = 2010, linetype = 2, colour = "black", size = 1) +
  geom_vline(xintercept = 2019, linetype = 2, colour = "red", size = 1) +
   scale_x_continuous(breaks = unique(site_evenness_df$year)) +
   labs(y = "Macroalgal evenness \n",
        x = "Year",
        title = "d. Site-level evenness") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=18), 
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size=18), 
        plot.title = element_text(size=18),
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.text = element_text(size = rel(1)), # increase legend text
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black")) )

# ggsave(filename = "output/figure_2d.png", figure_2d, height = 10, width = 14)
```

## evenness and cover relationships

```{r evenness cover quad level model}
alpha_diversity_quad_macro_evenness_mod <- alpha_diversity_quad_macro %>% 
  drop_na(evenness)

evenness_cover_mod_quad <- glmmTMB(cover_trans ~ evenness*habitat + (1|site/location) + (1|year), family = beta_family(), data = alpha_diversity_quad_macro_evenness_mod)
summary(evenness_cover_mod_quad)
Anova(evenness_cover_mod_quad)
#                     Chisq Df Pr(>Chisq)    
# richness         30916.73  1  < 2.2e-16 ***
# habitat            141.78  3  < 2.2e-16 ***
# richness:habitat   294.54  3  < 2.2e-16 ***
hist(residuals(evenness_cover_mod_quad)) # slight pos skeq
plot(residuals(evenness_cover_mod_quad) ~ fitted(evenness_cover_mod_quad)) # negative trend but it can't be less than 0 so not too concerned. some wave pattern
r.squaredGLMM(evenness_cover_mod_quad) # 0.1749907, 0.4042826
emtrends(evenness_cover_mod_quad, pairwise ~ habitat, var = "evenness") #backreef is different from everything except outer 17, but just barely. everyone else is same same xoxo

```


```{r evenness cover plot setup}
diversity_ranges_quad_evenness <- alpha_diversity_quad_macro_evenness_mod %>%
  group_by(habitat) %>%
  summarise(min_evenness = min(evenness),
            max_evenness = max(evenness),
            min_cover= min(cover_trans),
            max_cover = max(cover_trans))

cover_emm_evenness <- emmip(evenness_cover_mod_quad,
                        habitat ~ evenness,
                        at = list(evenness = seq(0,10,1)), plotit = F, CIs = T)

filtered_cover_effects_evenness <- cover_emm_evenness %>%
  left_join(diversity_ranges_quad_evenness, by = c("habitat")) %>%
  filter(evenness >= min_evenness & evenness <= max_evenness)

# alpha_diversity_quad_macro_evenness_mod$habitat <- factor(alpha_diversity_quad_macro_evenness_mod$habitat, 
#                              levels = c("fringing", "backreef", "outer_10","outer_17"),
#                              labels = c("Fringing", "Backreef", "Forereef 10m", "Forereef 17m"))
# 
# 
# filtered_cover_effects_evenness$habitat <- factor(filtered_cover_effects_evenness$habitat, 
#                              levels = c("fringing", "backreef", "outer_10","outer_17"),
#                              labels = c("Fringing", "Backreef", "Forereef 10m", "Forereef 17m"))
```

```{r evenness cover plot}
(figure_3b <- 
  ggplot() +
  geom_point(data = alpha_diversity_quad_macro_evenness_mod,
             aes(x = evenness, y = cover_trans, colour = habitat), size = 1, alpha = 0.005) + 
  geom_line(data = filtered_cover_effects_evenness, aes(x = evenness, y = inv_logit(yvar), colour = habitat)) +
  geom_ribbon(data = filtered_cover_effects_evenness, aes(x = evenness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Cover\n", x = "Macroalgal evenness", title = "3b.") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=18), 
        axis.title.y = element_text(size=18), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.text = element_text(size = rel(1)), # increase legend text
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

#ggsave(filename = "output/figure_3b.png", figure_3b, height = 10, width = 14)
```

## site level evenness versus cover

### model


### site evenness 
```{r site level evenness}
alpha_diversity_site_macro_evenness_mod <- alpha_diversity_site_macro %>% 
  drop_na(evenness)

evenness_site_cover_mod <- glmmTMB(cover_trans ~ evenness*habitat + (1|site_habitat) + (1|year), family = beta_family(), data = alpha_diversity_site_macro_evenness_mod)
summary(evenness_site_cover_mod)
Anova(evenness_site_cover_mod)
#                    Chisq Df Pr(>Chisq)    
# richness         58.9195  1  1.643e-14 ***
# habitat           6.6247  3    0.08487 .  
# richness:habitat  3.2967  3    0.34811    
hist(residuals(evenness_site_cover_mod)) # some positive skew, not the worst thing ever
plot(residuals(evenness_site_cover_mod) ~ fitted(evenness_site_cover_mod)) # a little heteroscedastic but can't be less than 0
r.squaredGLMM(evenness_site_cover_mod) #0.1206569, 0.5852773
emtrends(evenness_site_cover_mod, pairwise ~ habitat, var = "evenness") # only the outers are different from each other
```

```{r evenness cover model site level}
evenness_cover_mod_site <- glmmTMB(cover_trans ~ evenness*habitat + (1|site) + (1|year), family = beta_family(), data = alpha_diversity_site_macro_evenness_mod)
summary(evenness_cover_mod_site)
hist(residuals(evenness_cover_mod_site)) # little wonky but not the worst
plot(residuals(evenness_cover_mod_site) ~ fitted(evenness_cover_mod_site))
Anova(evenness_cover_mod_site)
#                   Chisq Df Pr(>Chisq)    
# evenness         14.395  1  0.0001482 ***
# habitat          45.636  3  6.777e-10 ***
# evenness:habitat 16.126  3  0.0010687 ** 
r.squaredGLMM(evenness_cover_mod_site) # 0.166, 0.258

emtrends(evenness_cover_mod_site, pairwise ~ habitat, var = "evenness") # fringing different from backreef and outer10
```

### plot setup

```{r figure 3f evenness site plot setup}
diversity_ranges_site_evenness <- alpha_diversity_site_macro_evenness_mod %>%
  group_by(habitat) %>%
  summarise(min_evenness = min(evenness),
            max_evenness = max(evenness),
            min_cover= min(cover_trans),
            max_cover = max(cover_trans))

cover_emm_evenness_site <- emmip(evenness_cover_mod_site,
                        habitat ~ evenness,
                        at = list(evenness = seq(0,1,0.01)), plotit = F, CIs = T)

filtered_cover_effects_evenness_site <- cover_emm_evenness_site %>%
  left_join(diversity_ranges_site_evenness, by = c("habitat")) %>%
  filter(evenness >= min_evenness & evenness <= max_evenness)

# alpha_diversity_site_macro_evenness_mod$habitat <- factor(alpha_diversity_site_macro_evenness_mod$habitat, 
#                              levels = c("fringing", "backreef", "outer_10","outer_17"),
#                              labels = c("Fringing", "Backreef", "Forereef 10m", "Forereef 17m"))
# 
# 
# 
```

### plot

```{r evenness cover plot site }
(figure_3f <- 
  ggplot() +
  geom_point(data = alpha_diversity_site_macro_evenness_mod,
             aes(x = evenness, y = cover_trans, colour = habitat), size = 1, alpha = 0.5) + 
  geom_line(data = filtered_cover_effects_evenness_site, aes(x = evenness, y = inv_logit(yvar), colour = habitat)) +
  geom_ribbon(data = filtered_cover_effects_evenness_site, aes(x = evenness, ymin = inv_logit(LCL), ymax = inv_logit(UCL), fill = habitat),
              alpha = 0.3) +
  scale_colour_manual(values = habitat_colours) +
  scale_fill_manual(values = habitat_colours) +
  labs(y = "Cover\n", x = "Macroalgal evenness", title = "3f. Site Level Evenness") +
  theme_bw() + 
  theme(axis.title.x = element_text(size=18), 
        axis.title.y = element_text(size=18), 
        panel.background = element_blank(), 
        panel.grid.major = element_blank(),  #remove major-grid labels
        panel.grid.minor = element_blank(),  #remove minor-grid labels
        plot.background = element_rect(fill = "white"),
        legend.text = element_text(size = rel(1)), # increase legend text
        legend.title = element_blank(),
        legend.position = 'bottom', # move legend to bottom
        legend.box = 'horizontal', # make legend horizontal
        legend.box.background = element_rect(colour = "black"))  # add box around legend
         )

# ggsave(filename = "output/figure_3f.png", figure_3f, height = 10, width = 14)
```

